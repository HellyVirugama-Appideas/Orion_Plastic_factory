<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">

<head>
    <%- include('_layouts/head') %>
        <title>Drivers Management | <%= title %>
        </title>

        <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/jquery.dataTables.min.css">
        <link rel="stylesheet" type="text/css"
            href="/app-assets/vendors/data-tables/extensions/responsive/css/responsive.dataTables.min.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/select.dataTables.min.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/css/pages/data-tables.css">

        <style>
            table tr td,
            th {
                text-align: center;
            }

            [type='checkbox']+span:not(.lever):before {
                border-color: black;
            }

            [type='checkbox']:checked+span:not(.lever):before {
                border-right-color: black;
                border-bottom-color: black;
            }

            /* Name cell with ellipsis */
            .name-cell {
                max-width: 240px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .company-name {
                font-weight: bold;
                display: block;
            }

            .individual-name {
                font-size: 0.9em;
                color: #555;
            }

            /* âœ… REMOVED - Don't hide sorting icons anymore */
            /* table.dataTable thead th {
                background-image: none !important;
            }

            table.dataTable thead .sorting:before,
            table.dataTable thead .sorting:after,
            table.dataTable thead .sorting_asc:before,
            table.dataTable thead .sorting_asc:after,
            table.dataTable thead .sorting_desc:before,
            table.dataTable thead .sorting_desc:after {
                display: none !important;
            } */

            /* Clickable row styling */
            tr.driver-row {
                cursor: pointer;
                transition: background-color 0.2s;
            }

            tr.driver-row:hover {
                background-color: #f5f5f5 !important;
            }

            /* Prevent row click on special columns */
            td.checkbox-column,
            td.actions-column {
                cursor: default;
            }

            td.actions-column a,
            td.checkbox-column input,
            td.checkbox-column label,
            .status-toggle,
            .lever {
                pointer-events: auto !important;
            }
        </style>
</head>

<body
    class="vertical-layout page-header-light vertical-menu-collapsible vertical-dark-menu preload-transitions 2-columns"
    data-open="click" data-menu="vertical-dark-menu" data-col="2-columns">

    <%- include('_layouts/sidenavbar') %>

        <div id="main">
            <div class="row">
                <div class="pt-1 pb-0" id="breadcrumbs-wrapper">
                    <div class="container">
                        <div class="row">
                            <%- include('messages', { messages: messages }) %>
                                <div class="col s12 m6 l6">
                                    <h6 class="breadcrumbs-title"><span>Manage Drivers</span></h6>
                                </div>
                                <div class="col s12 m6 l6 right-align-md" style="margin-top: -10px;">
                                    <ol class="breadcrumbs mb-0">
                                        <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
                                        <li class="breadcrumb-item active">Drivers</li>
                                    </ol>
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="breadcrumbs-wrapper" style="background-color: white;">
                <div class="container">
                    <div class="row">
                        <div class="col s12 right-align-md">
                            <a class="btn pull-right btn-add btn-breadcrumbs white-text"
                                href="/admin/drivers/create">Create Driver</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col s12">
                <div class="container">
                    <div class="section section-data-tables">
                        <div class="row">
                            <div class="col s12">
                                <div class="card">
                                    <div class="card-content">
                                        <div class="row">
                                            <div class="col s12 overflow">
                                                <table id="page-length-option" class="display">
                                                    <thead>
                                                        <tr>
                                                            <th>Sr</th>
                                                            <th>Profile</th>
                                                            <th>Name</th>
                                                            <th>Phone</th>
                                                            <th>Email</th>
                                                            <th>Vehicle Number</th>
                                                            <th>Status</th>
                                                            <th>Blocked</th>
                                                            <th>Created Date</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% if (drivers && drivers.length> 0) { %>
                                                            <% drivers.forEach((driver, index)=> { %>
                                                                <!-- Clickable row -->
                                                                <tr class="driver-row"
                                                                    data-href="/admin/drivers/view/<%= driver._id %>">
                                                                    <td>
                                                                        <%= index + 1 %>
                                                                    </td>

                                                                    <td>
                                                                        <img src="<%= driver.profileImage || '/img/avatar.png' %>"
                                                                            alt="Profile"
                                                                            style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;" />
                                                                    </td>
                                                                    <td>
                                                                        <%= driver.name || 'N/A' %>
                                                                    </td>
                                                                    <td>
                                                                        <%= driver.phone || 'N/A' %>
                                                                    </td>
                                                                    <td>
                                                                        <%= driver.email || 'N/A' %>
                                                                    </td>
                                                                    <td>
                                                                        <%= driver.vehicleNumber || 'Not Assigned' %>
                                                                    </td>

                                                                    <!-- Toggle Switch for Status -->
                                                                    <td>
                                                                        <div class="switch">
                                                                            <label>
                                                                                <input type="checkbox"
                                                                                    class="status-toggle"
                                                                                    data-driver-id="<%= driver._id %>"
                                                                                    <%=driver.isActive ? 'checked' : ''
                                                                                    %>>
                                                                                <span class="lever"></span>
                                                                            </label>
                                                                        </div>
                                                                    </td>

                                                                    <td>
                                                                        <span class="badge" style="
                                                                        background-color: <%= driver.profileStatus === 'approved' ? 'rgb(212, 240, 216)' : 
                                                                        driver.profileStatus === 'rejected' ? 'rgb(240, 212, 212)' : 
                                                                        driver.profileStatus === 'pending' ? 'orange' : 'rgba(163, 149, 149, 0.263)' %>;
                                                                        color: <%= driver.profileStatus === 'approved' ? 'green' : 
                                                                        driver.profileStatus === 'rejected' ? 'red' : 
                                                                        driver.profileStatus === 'pending' ? '#fff' : '#000' %>;
                                                                        border-radius: 5px;">
                                                                            <%= driver.profileStatus==='approved'
                                                                                ? 'Approved' :
                                                                                driver.profileStatus==='rejected'
                                                                                ? 'Rejected' :
                                                                                driver.profileStatus==='pending'
                                                                                ? 'Pending' : 'Under Review' %>
                                                                        </span>
                                                                    </td>

                                                                    <td>
                                                                        <% let formattedDate='-' ; if (driver.createdAt)
                                                                            { const d=new Date(driver.createdAt); const
                                                                            day=String(d.getUTCDate()).padStart(2, '0'
                                                                            ); const month=String(d.getUTCMonth() +
                                                                            1).padStart(2, '0' ); const
                                                                            year=d.getUTCFullYear(); const
                                                                            hours=String(d.getUTCHours()).padStart(2, '0'
                                                                            ); const
                                                                            minutes=String(d.getUTCMinutes()).padStart(2, '0'
                                                                            ); formattedDate=`${day}-${month}-${year}
                                                                            ${hours}:${minutes}`; } %>
                                                                            <%= formattedDate %>
                                                                    </td>

                                                                    <td class="actions-column">
                                                                        <a href="/admin/drivers/view/<%= driver._id %>"
                                                                            class="waves-effect waves-light accent-2 btn-edit"
                                                                            title="View Details">
                                                                            <i class="material-icons">visibility</i>
                                                                        </a>
                                                                        &nbsp;&nbsp;
                                                                        <a href="/admin/drivers/edit/<%= driver._id %>"
                                                                            class="btn-floating waves-effect waves-light accent-2 btn-edit"
                                                                            title="Edit">
                                                                            <i class="material-icons">edit</i>
                                                                        </a>
                                                                        &nbsp;&nbsp;
                                                                        <a href="#"
                                                                            class="btn-floating waves-effect waves-light red delete-driver"
                                                                            data-driver-id="<%= driver._id %>"
                                                                            data-driver-name="<%= driver.name %>"
                                                                            title="Delete Driver">
                                                                            <i class="material-icons">delete</i>
                                                                        </a>
                                                                    </td>
                                                                </tr>
                                                                <% }) %>
                                                                    <% } else { %>
                                                                        <tr>
                                                                            <td colspan="10"
                                                                                class="center-align grey-text">
                                                                                No drivers found matching
                                                                                your criteria
                                                                            </td>
                                                                        </tr>
                                                                        <% } %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pagination -->
                        <% if (pagination && pagination.totalPages> 1) { %>
                            <div class="right-align mt-2">
                                Page <%= pagination.currentPage %> of <%= pagination.totalPages %>
                                        <% if (pagination.currentPage> 1) { %>
                                            <a href="?page=<%= pagination.currentPage - 1 %>&<%= new URLSearchParams(filters).toString() %>"
                                                class="btn-flat">Prev</a>
                                            <% } %>
                                                <% if (pagination.currentPage < pagination.totalPages) { %>
                                                    <a href="?page=<%= pagination.currentPage + 1 %>&<%= new URLSearchParams(filters).toString() %>"
                                                        class="btn-flat">Next</a>
                                                    <% } %>
                            </div>
                            <% } %>
                    </div>
                </div>
            </div>
        </div>

        <%- include('_layouts/commonJs') %>

            <script src="/app-assets/vendors/data-tables/js/jquery.dataTables.min.js"></script>
            <script src="/app-assets/js/scripts/data-tables.js"></script>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    // Select All Checkbox
                    const selectAll = document.getElementById('selectAll');
                    const checkboxes = document.querySelectorAll('input[name="selectedUsers[]"]');

                    if (selectAll) {
                        selectAll.addEventListener('change', function () {
                            checkboxes.forEach(cb => cb.checked = this.checked);
                        });
                    }

                    M.FormSelect.init(document.querySelectorAll('select'));

                    // Status Toggle AJAX
                    document.querySelectorAll('.status-toggle').forEach(toggle => {
                        toggle.addEventListener('change', async function () {
                            const driverId = this.getAttribute('data-driver-id');
                            const isActive = this.checked;
                            const newStatus = isActive ? 'active' : 'inactive';

                            this.disabled = true;

                            try {
                                const response = await fetch(`/admin/drivers/${driverId}/toggle-status`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ isActive: isActive })
                                });

                                const result = await response.json();

                                if (result.success) {
                                    M.toast({ html: `Driver status updated to ${newStatus.toUpperCase()}`, classes: 'green' });
                                } else {
                                    this.checked = !isActive;
                                    M.toast({ html: result.message || 'Failed to update status', classes: 'red' });
                                }
                            } catch (err) {
                                this.checked = !isActive;
                                M.toast({ html: 'Network error. Try again.', classes: 'red' });
                            } finally {
                                this.disabled = false;
                            }
                        });
                    });

                    // Make entire row clickable (except special areas)
                    document.querySelectorAll('tr.driver-row').forEach(row => {
                        row.addEventListener('click', function (e) {
                            // Prevent navigation if clicked on these elements
                            if (e.target.closest('.checkbox-column') ||
                                e.target.closest('.actions-column') ||
                                e.target.closest('.status-toggle') ||
                                e.target.closest('.lever') ||
                                e.target.tagName === 'INPUT' ||
                                e.target.tagName === 'LABEL' ||
                                e.target.tagName === 'A') {
                                return;
                            }

                            const href = this.getAttribute('data-href');
                            if (href) {
                                window.location.href = href;
                            }
                        });
                    });

                    // Delete Confirmation with Event Listener
                    document.querySelectorAll('.delete-driver').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const driverId = this.getAttribute('data-driver-id');
                            const driverName = this.getAttribute('data-driver-name');
                            
                            if (confirm(`Are you sure you want to delete driver "${driverName}"? This action cannot be undone.`)) {
                                const form = document.createElement('form');
                                form.method = 'POST';
                                form.action = `/admin/drivers/delete/${driverId}`;
                                document.body.appendChild(form);
                                form.submit();
                            }
                        });
                    });
                });
            </script>
</body>

</html>