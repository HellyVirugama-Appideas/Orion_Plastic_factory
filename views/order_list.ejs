<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">

<head>
    <%- include('_layouts/head') %>
        <title>Orders Management | <%= title %>
        </title>

        <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/jquery.dataTables.min.css">
        <link rel="stylesheet" type="text/css"
            href="/app-assets/vendors/data-tables/extensions/responsive/css/responsive.dataTables.min.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/select.dataTables.min.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/css/pages/data-tables.css">

        <style>
            table tr td,
            th {
                text-align: center;
            }

            [type='checkbox']+span:not(.lever):before {
                border-color: black;
            }

            [type='checkbox']:checked+span:not(.lever):before {
                border-right-color: black;
                border-bottom-color: black;
            }

            /* Status Badge Styling */
            .status-badge {
                padding: 6px 14px;
                border-radius: 4px;
                font-size: 0.85rem;
                font-weight: 500;
                display: inline-block;
                text-transform: capitalize;
            }

            /* Status-specific styles */
            .status-pending {
                background: #fff3cd;
                color: #856404 !important;
                border: 1px solid #ffeeba;
            }

            .status-confirmed {
                background: #d4edda;
                color: #155724 !important;
                border: 1px solid #c3e6cb;
            }

            .status-processing {
                background: #cce5ff;
                color: #004085 !important;
                border: 1px solid #b8daff;
            }

            .status-ready_for_pickup {
                background: #e2e3ff;
                color: #3f51b5 !important;
                border: 1px solid #d1d4ff;
            }

            .status-assigned {
                background: #fff0d4;
                color: #e65100 !important;
                border: 1px solid #ffe0b2;
            }

            .status-in_transit {
                background: #b3e5fc;
                color: #01579b !important;
                border: 1px solid #81d4fa;
            }

            .status-delivered {
                background: #c8e6c9;
                color: #1b5e20 !important;
                border: 1px solid #a5d6a7;
            }

            .status-cancelled,
            .status-rejected {
                background: #ffcdd2;
                color: #b71c1c !important;
                border: 1px solid #ef9a9a;
            }

            .status-on_hold {
                background: #f5f5f5;
                color: #424242;
                border: 1px solid #e0e0e0;
            }

            /* Priority Colors (same as before) */
            .priority-urgent {
                color: #d32f2f;
                font-weight: 700;
            }

            .priority-high {
                color: #f57c00;
                font-weight: 700;
            }

            .priority-medium {
                color: #ffa000;
            }

            .priority-low {
                color: #757575;
            }

            /* Table & Other Styles (unchanged but kept for completeness) */
            table tr td,
            th {
                text-align: center;
                vertical-align: middle !important;
                padding: 12px 8px !important;
            }

            .action-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }

            @media (max-width: 768px) {
                .action-buttons {
                    flex-direction: column;
                    align-items: center;
                }
            }
        </style>
</head>

<body
    class="vertical-layout page-header-light vertical-menu-collapsible vertical-dark-menu preload-transitions 2-columns"
    data-open="click" data-menu="vertical-dark-menu" data-col="2-columns">

    <%- include('_layouts/sidenavbar') %>

        <div id="main">
            <div class="row">
                <div class="pt-1 pb-0" id="breadcrumbs-wrapper">
                    <div class="container">
                        <div class="row">
                            <%- include('messages', { messages: messages }) %>
                                <div class="col s12 m6 l6">
                                    <h6 class="breadcrumbs-title"><span>Manage Orders</span></h6>
                                </div>
                                <div class="col s12 m6 l6 right-align-md"
                                    style="display: flex; justify-content: flex-end; gap: 10px;">
                                    <a class="btn pull-right btn-add btn-breadcrumbs white-text"
                                        href="/admin/orders/create">Create Order</a>
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col s12">
                <div class="container">
                    <div class="section section-data-tables">
                        <div class="row">
                            <div class="col s12">
                                <div class="card">
                                    <div class="card-content">
                                        <div class="row">
                                            <div class="col s12 overflow">
                                                <table id="page-length-option" class="display">
                                                    <thead>
                                                        <tr>
                                                            <th>Sr</th>
                                                            <th style="width: 60px; text-align: center;">
                                                                <label
                                                                    style="margin: 0; display: flex; align-items: center; justify-content: center;">
                                                                    <input type="checkbox" id="selectAll" />
                                                                    <span style="margin-left: 4px;">All</span>
                                                                </label>
                                                            </th>
                                                            <th>Order Number</th>
                                                            <th>Customer</th>
                                                            <th>Items</th>
                                                            <th>Status</th>
                                                            <th>Priority</th>
                                                            <th>Created Date</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% if (orders && orders.length> 0) { %>
                                                            <% orders.forEach((order, index)=> { %>
                                                                <tr>
                                                                    <td>
                                                                        <%= index + 1 %>
                                                                    </td>
                                                                    <td>
                                                                        <label>
                                                                            <input type="checkbox"
                                                                                name="selectedOrders[]"
                                                                                value="<%= order._id %>" />
                                                                            <span></span>
                                                                        </label>
                                                                    </td>
                                                                    <td><strong>
                                                                            <%= order.orderNumber %>
                                                                        </strong></td>
                                                                    <td>
                                                                        <% if (order.customerId) { %>
                                                                            <%= order.customerId.companyName ||
                                                                                order.customerId.name || 'N/A' %><br>
                                                                                <% if (order.customerId.customerId) { %>
                                                                                    <br><small class="grey-text">ID: <%=
                                                                                            order.customerId.customerId
                                                                                            %></small>
                                                                                    <% } %>
                                                                                        <% } else { %>
                                                                                            <span
                                                                                                class="grey-text">Customer
                                                                                                N/A</span>
                                                                                            <% } %>
                                                                    </td>
                                                                    <td>
                                                                        <%= order.items?.length || 0 %> item(s)
                                                                    </td>

                                                                    <td>
                                                                        <span class="badge status-<%= order.status %>">
                                                                            <%= order.status?.replace(/_/g, ' '
                                                                                ).toUpperCase() || 'UNKNOWN' %>
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        <span
                                                                            class="priority-<%= order.priority || 'medium' %>">
                                                                            <%= (order.priority || 'medium'
                                                                                ).toUpperCase() %>
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        <% let formattedDate='-' ; if (order.createdAt)
                                                                            { const createdAt=new Date(order.createdAt);
                                                                            const
                                                                            day=String(createdAt.getUTCDate()).padStart(2, '0'
                                                                            ); const
                                                                            month=String(createdAt.getUTCMonth() +
                                                                            1).padStart(2, '0' ); const
                                                                            year=createdAt.getUTCFullYear(); const
                                                                            hours=String(createdAt.getUTCHours()).padStart(2, '0'
                                                                            ); const
                                                                            minutes=String(createdAt.getUTCMinutes()).padStart(2, '0'
                                                                            ); formattedDate=`${day}-${month}-${year}
                                                                            ${hours}:${minutes}`; } %>
                                                                            <%= formattedDate %>
                                                                    </td>
                                                                    <td>
                                                                        <a href="/admin/orders/view/<%= order._id %>"
                                                                            class="waves-effect waves-light accent-2 btn-edit">
                                                                            <i class="material-icons">visibility</i>
                                                                        </a>
                                                                        &nbsp;&nbsp;
                                                                        <a href="/admin/orders/edit/<%= order._id %>"
                                                                            class="btn-floating waves-effect waves-light accent-2 btn-edit">
                                                                            <i class="material-icons">edit</i>
                                                                        </a>
                                                                        &nbsp;&nbsp;
                                                                        <a href="#"
                                                                            class="btn-floating waves-effect waves-light accent-2 btn-delete"
                                                                            onclick="confirmDelete('<%= order._id %>', '<%= order.orderNumber %>')"
                                                                            style="margin-left: 10px;">
                                                                            <i class="material-icons">delete</i>
                                                                        </a>
                                                                        &nbsp;&nbsp;
                                                                        <% if (!order.deliveryId &&
                                                                            ['confirmed','processing','ready_for_pickup'].includes(order.status))
                                                                            { %>
                                                                            <a href="/admin/orders/<%= order._id %>/create-delivery"
                                                                                class="btn-floating waves-effect waves-light green">
                                                                                <i
                                                                                    class="material-icons">local_shipping</i>
                                                                            </a>
                                                                            <% } %>
                                                                                <% if (order.status==='pending' ) { %>
                                                                                    &nbsp;&nbsp;
                                                                                    <a href="#"
                                                                                        onclick="confirmOrder('<%= order._id %>')"
                                                                                        class="btn-floating waves-effect waves-light orange">
                                                                                        <i
                                                                                            class="material-icons">check</i>
                                                                                    </a>
                                                                                    <% } %>
                                                                    </td>
                                                                </tr>
                                                                <% }) %>
                                                                    <% } else { %>
                                                                        <tr>
                                                                            <td colspan="11"
                                                                                class="center-align grey-text">No orders
                                                                                found matching your criteria</td>
                                                                        </tr>
                                                                        <% } %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pagination -->
                        <% if (pagination && pagination.pages> 1) { %>
                            <div class="right-align mt-2">
                                Page <%= pagination.page %> of <%= pagination.pages %>
                                        <% if (pagination.page> 1) { %>
                                            <a href="?page=<%= pagination.page - 1 %>&<%= new URLSearchParams(Object.assign({}, filters, {page: pagination.page - 1})).toString() %>"
                                                class="btn-flat">Prev</a>
                                            <% } %>
                                                <% if (pagination.page < pagination.pages) { %>
                                                    <a href="?page=<%= pagination.page + 1 %>&<%= new URLSearchParams(Object.assign({}, filters, {page: pagination.page + 1})).toString() %>"
                                                        class="btn-flat">Next</a>
                                                    <% } %>
                            </div>
                            <% } %>
                    </div>
                </div>
            </div>
        </div>

        <%- include('_layouts/commonJs') %>

            <script src="/app-assets/vendors/data-tables/js/jquery.dataTables.min.js"></script>
            <script src="/app-assets/js/scripts/data-tables.js"></script>

            <script>
                // Select All Checkbox
                document.addEventListener('DOMContentLoaded', function () {
                    const selectAll = document.getElementById('selectAll');
                    const checkboxes = document.querySelectorAll('input[name="selectedOrders[]"]');

                    if (selectAll) {
                        selectAll.addEventListener('change', function () {
                            checkboxes.forEach(cb => cb.checked = this.checked);
                        });
                    }

                    // Initialize Materialize selects
                    M.FormSelect.init(document.querySelectorAll('select'));
                });

                // Confirm Order
                function confirmOrder(orderId) {
                    if (!confirm('Confirm this order?')) return;

                    fetch(`/admin/orders/${orderId}/confirm`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ remarks: 'Confirmed by admin' })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                M.toast({ html: 'Order confirmed successfully!', classes: 'green rounded' });
                                setTimeout(() => location.reload(), 1200);
                            } else {
                                M.toast({ html: data.message || 'Failed to confirm', classes: 'red rounded' });
                            }
                        })
                        .catch(() => M.toast({ html: 'Network error', classes: 'red rounded' }));
                }

                // Confirm Delete
                function confirmDelete(orderId, orderNumber) {
                    if (!confirm(`Are you sure you want to delete order "${orderNumber}"? This action cannot be undone.`)) {
                        return;
                    }

                    // Create form and submit POST request
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/admin/orders/delete/${orderId}`;

                    document.body.appendChild(form);
                    form.submit();
                }
            </script>
</body>

</html>