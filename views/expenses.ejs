<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">

<head>
    <%- include('_layouts/head') %>
        <title>Expense Management | <%= title %>
        </title>

        <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/jquery.dataTables.min.css">
        <link rel="stylesheet" type="text/css"
            href="/app-assets/vendors/data-tables/extensions/responsive/css/responsive.dataTables.min.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/select.dataTables.min.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/css/pages/data-tables.css">

        <style>
            table tr td,
            th {
                text-align: center;
            }

            [type='checkbox']+span:not(.lever):before {
                border-color: black;
            }

            [type='checkbox']:checked+span:not(.lever):before {
                border-right-color: black;
                border-bottom-color: black;
            }

            .status-badge {
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 0.85rem;
                display: inline-block;
            }

            .Pending {
                background: #fff3cd;
                color: #856404;
            }

            .Approved {
                background: #d4edda;
                color: #155724;
            }

            .Rejected {
                background: #f8d7da;
                color: #721c24;
            }

            /* Minimal addition for row click feature - only cursor */
            tr.expense-row {
                cursor: pointer;
            }

            td.checkbox-column,
            td.actions-column {
                cursor: default;
            }
        </style>
</head>

<body
    class="vertical-layout page-header-light vertical-menu-collapsible vertical-dark-menu preload-transitions 2-columns"
    data-open="click" data-menu="vertical-dark-menu" data-col="2-columns">

    <%- include('_layouts/sidenavbar') %>

        <div id="main">
            <div class="row">
                <div class="pt-1 pb-0" id="breadcrumbs-wrapper">
                    <div class="container">
                        <div class="row">
                            <%- include('messages', { messages: messages }) %>
                                <div class="col s12 m6 l6">
                                    <h6 class="breadcrumbs-title"><span>Manage Expenses</span></h6>
                                </div>
                                <div class="col s12 m6 l6 right-align-md" style="margin-top: -10px;">
                                    <ol class="breadcrumbs mb-0">
                                        <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
                                        <li class="breadcrumb-item active">Expense</li>
                                    </ol>
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col s12">
                <div class="container">
                    <div class="section section-data-tables">
                        <div class="row">
                            <div class="col s12">
                                <div class="card">
                                    <div class="card-content">
                                        <div class="row">
                                            <div class="col s12 overflow">
                                                <table id="page-length-option" class="display">
                                                    <thead>
                                                        <tr>
                                                            <th>Sr</th>
                                                            <!-- <th style="width: 60px; text-align: center;">
                                                            <label style="margin: 0; display: flex; align-items: center; justify-content: center;">
                                                                <input type="checkbox" id="selectAll" />
                                                                <span style="margin-left: 4px;">All</span>
                                                            </label>
                                                        </th> -->
                                                            <th>Date</th>
                                                            <th>Driver</th>
                                                            <th>Vehicle</th>
                                                            <th>Type</th>
                                                            <th>Amount (₹)</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% if (expenses && expenses.length> 0) { %>
                                                            <% expenses.forEach((exp, index)=> { %>
                                                                <!-- Added class & data-href for row click -->
                                                                <tr class="expense-row"
                                                                    data-href="/admin/expenses/<%= exp._id %>">
                                                                    <td class="checkbox-column">
                                                                        <%= index + 1 + ((pagination?.page - 1) *
                                                                            (pagination?.limit || 20) || 0) %>
                                                                    </td>

                                                                    <td>
                                                                        <%= new
                                                                            Date(exp.expenseDate).toLocaleDateString('en-IN')
                                                                            %>
                                                                    </td>
                                                                    <td>
                                                                        <%= exp.driver?.name || 'N/A' %><br>
                                                                    </td>
                                                                    <td>
                                                                        <%= exp.vehicle?.vehicleNumber || 'N/A' %>
                                                                    </td>
                                                                    <td>
                                                                        <span class="badge" style="
                                                                        background-color: <%= exp.expenseType === 'fuel' ? 'rgb(212, 240, 216)' : 'rgb(212 215 240)' %>;
                                                                        color: <%= exp.expenseType === 'fuel' ? 'green' : 'blue' %>;
                                                                    ">
                                                                            <%= exp.expenseType.toUpperCase() %>
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        ₹ <%= (exp.expenseType==='fuel' ?
                                                                            (exp.fuelDetails?.totalFuelCost || 0) :
                                                                            (exp.vehicleExpenseDetails?.expenseAmount ||
                                                                            0)).toLocaleString('en-IN') %>
                                                                    </td>
                                                                    <td>
                                                                        <span
                                                                            class="status-badge <%= exp.approvalStatus %>">
                                                                            <%= exp.approvalStatus.replace(/_/g, ' '
                                                                                ).toUpperCase() %>
                                                                        </span>
                                                                    </td>
                                                                    <td class="actions-column">
                                                                        <a href="/admin/expenses/<%= exp._id %>"
                                                                            class="waves-effect waves-light accent-2 btn-edit"
                                                                            title="View Details">
                                                                            <i class="material-icons">visibility</i>
                                                                        </a>
                                                                    </td>
                                                                </tr>
                                                                <% }) %>
                                                                    <% } else { %>
                                                                        <tr>
                                                                            <td colspan="8"
                                                                                class="center-align grey-text">
                                                                                No expenses found matching your criteria
                                                                            </td>
                                                                        </tr>
                                                                        <% } %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pagination - FIXED with currentQuery -->
                        <% if (pagination && pagination.pages> 1) { %>
                            <div class="right-align mt-2">
                                Page <%= pagination.page %> of <%= pagination.pages %> (Total: <%= pagination.total %>)

                                            <% if (pagination.page> 1) { %>

                                                <a href="?page=<%= pagination.page - 1 %><%= currentQuery ? '&' + currentQuery : '' %>"
                                                    class="btn-flat">Prev</a>
                                                <% } %>

                                                    <% if (pagination.page < pagination.pages) { %>
                                                        <a href="?page=<%= pagination.page + 1 %><%= currentQuery ? '&' + currentQuery : '' %>"
                                                            class="btn-flat">Next</a>
                                                        <% } %>
                            </div>
                            <% } %>
                    </div>
                </div>
            </div>

            <%- include('_layouts/commonJs') %>

                <script src="/app-assets/vendors/data-tables/js/jquery.dataTables.min.js"></script>
                <script src="/app-assets/js/scripts/data-tables.js"></script>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        // Select All Checkbox
                        const selectAll = document.getElementById('selectAll');
                        const checkboxes = document.querySelectorAll('input[name="selectedExpenses[]"]');

                        if (selectAll) {
                            selectAll.addEventListener('change', function () {
                                checkboxes.forEach(cb => cb.checked = this.checked);
                            });
                        }

                        M.FormSelect.init(document.querySelectorAll('select'));

                        // Make entire row clickable (except actions & checkbox)
                        document.querySelectorAll('tr.expense-row').forEach(row => {
                            row.addEventListener('click', function (e) {
                                // Prevent navigation if clicked on protected areas
                                if (e.target.closest('.checkbox-column') ||
                                    e.target.closest('.actions-column') ||
                                    e.target.tagName === 'INPUT' ||
                                    e.target.tagName === 'LABEL' ||
                                    e.target.tagName === 'A' ||
                                    e.target.closest('.btn-edit')) {
                                    return;
                                }

                                const href = this.getAttribute('data-href');
                                if (href) {
                                    window.location.href = href;
                                }
                            });
                        });
                    });
                </script>
</body>

</html>