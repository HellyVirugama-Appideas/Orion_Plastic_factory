<%- include('../layouts/header') %>

<div class="wrapper d-flex">
    <%- include('../layouts/sidebar') %>
    
    <div class="content-wrapper flex-grow-1">
        <div class="container-fluid p-4">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                <div>
                    <span class="badge bg-primary">
                        <i class="fas fa-calendar-day"></i> <%= new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
                    </span>
                </div>
            </div>
            
            <!-- Alert Messages -->
            <% if (typeof success !== 'undefined' && success) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> <%= success %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <% } %>
            
            <% if (typeof error !== 'undefined' && error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle"></i> <%= error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <% } %>
            
            <!-- Statistics Cards -->
            <div class="row g-4 mb-4">
                <div class="col-xl-3 col-md-6">
                    <div class="card stat-card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-2">Total Orders</h6>
                                    <h2 class="mb-0"><%= stats.totalOrders %></h2>
                                    <small><%= stats.pendingOrders %> Pending</small>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-shopping-cart fa-3x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6">
                    <div class="card stat-card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-2">Total Deliveries</h6>
                                    <h2 class="mb-0"><%= stats.totalDeliveries %></h2>
                                    <small><%= stats.activeDeliveries %> Active</small>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-truck fa-3x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6">
                    <div class="card stat-card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-2">Total Drivers</h6>
                                    <h2 class="mb-0"><%= stats.totalDrivers %></h2>
                                    <small><%= stats.availableDrivers %> Available</small>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-id-card fa-3x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6">
                    <div class="card stat-card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-2">Today's Revenue</h6>
                                    <h2 class="mb-0">₹<%= (stats.todayRevenue).toLocaleString() %></h2>
                                    <small>Total Customers: <%= stats.totalCustomers %></small>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-rupee-sign fa-3x opacity-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="row g-4 mb-4">
                <div class="col-xl-6">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Order Status Distribution</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="orderStatusChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-6">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Delivery Status Distribution</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="deliveryStatusChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Orders and Active Deliveries -->
            <div class="row g-4">
                <div class="col-xl-6">
                    <div class="card">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-clock"></i> Recent Orders</h5>
                            <a href="/admin/orders" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Order #</th>
                                            <th>Customer</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (recentOrders && recentOrders.length > 0) { %>
                                            <% recentOrders.forEach(order => { %>
                                                <tr>
                                                    <td>
                                                        <a href="/admin/orders/<%= order._id %>" class="text-decoration-none">
                                                            <%= order.orderNumber %>
                                                        </a>
                                                    </td>
                                                    <td><%= order.customerId?.name || 'N/A' %></td>
                                                    <td>₹<%= order.totalAmount.toLocaleString() %></td>
                                                    <td>
                                                        <span class="badge bg-<%= order.status === 'pending' ? 'warning' : order.status === 'confirmed' ? 'info' : order.status === 'delivered' ? 'success' : 'secondary' %>">
                                                            <%= order.status %>
                                                        </span>
                                                    </td>
                                                </tr>
                                            <% }) %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="4" class="text-center text-muted py-4">No recent orders</td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-6">
                    <div class="card">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-shipping-fast"></i> Active Deliveries</h5>
                            <a href="/admin/deliveries?status=in_transit" class="btn btn-sm btn-outline-success">View All</a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Tracking #</th>
                                            <th>Driver</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (activeDeliveries && activeDeliveries.length > 0) { %>
                                            <% activeDeliveries.forEach(delivery => { %>
                                                <tr>
                                                    <td>
                                                        <a href="/admin/deliveries/<%= delivery._id %>" class="text-decoration-none">
                                                            <%= delivery.trackingNumber %>
                                                        </a>
                                                    </td>
                                                    <td><%= delivery.driverId?.userId?.name || 'Unassigned' %></td>
                                                    <td>
                                                        <span class="badge bg-<%= delivery.status === 'in_transit' ? 'primary' : delivery.status === 'out_for_delivery' ? 'warning' : 'info' %>">
                                                            <%= delivery.status %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <a href="/admin/deliveries/<%= delivery._id %>/tracking" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-map-marked-alt"></i> Track
                                                        </a>
                                                    </td>
                                                </tr>
                                            <% }) %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="4" class="text-center text-muted py-4">No active deliveries</td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Order Status Chart
const orderStatusData = <%- JSON.stringify(orderStatusBreakdown) %>;
const orderLabels = orderStatusData.map(item => item._id);
const orderCounts = orderStatusData.map(item => item.count);

new Chart(document.getElementById('orderStatusChart'), {
    type: 'doughnut',
    data: {
        labels: orderLabels,
        datasets: [{
            data: orderCounts,
            backgroundColor: [
                '#ffc107', '#17a2b8', '#28a745', '#6c757d', 
                '#007bff', '#dc3545', '#6610f2'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Delivery Status Chart
const deliveryStatusData = <%- JSON.stringify(deliveryStatusBreakdown) %>;
const deliveryLabels = deliveryStatusData.map(item => item._id);
const deliveryCounts = deliveryStatusData.map(item => item.count);

new Chart(document.getElementById('deliveryStatusChart'), {
    type: 'bar',
    data: {
        labels: deliveryLabels,
        datasets: [{
            label: 'Deliveries',
            data: deliveryCounts,
            backgroundColor: '#007bff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>

<%- include('../layouts/footer') %>