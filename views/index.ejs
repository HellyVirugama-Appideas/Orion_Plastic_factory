<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">
<head>
  <%- include('_layouts/head') %>
  <title>Dashboard | <%= title %></title>
  <link rel="stylesheet" type="text/css" href="/app-assets/css/pages/dashboard.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    #driversMap {
      height: 500px;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
    }

    .map-card {
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }

    .live-badge {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }

    .live-pulse-dot {
      width: 10px;
      height: 10px;
      background: white;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.8); }
    }

    .map-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: flex;
      gap: 10px;
    }

    .map-control-btn {
      background: white;
      border: 1px solid #ddd;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
    }

    .map-control-btn:hover {
      background: #f5f5f5;
      border-color: #2196F3;
    }

    .map-control-btn.active {
      background: #2196F3;
      color: white;
    }

    .driver-legend {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-right: 20px;
      padding: 5px 12px;
      background: #f5f5f5;
      border-radius: 20px;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .legend-dot.available { background: #4CAF50; }
    .legend-dot.in-transit { background: #FF9800; }
    .legend-dot.offline { background: #9E9E9E; }

    /* Driver Marker Custom Style */
    .driver-marker {
      background: white;
      border-radius: 50%;
      padding: 3px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      animation: markerPulse 2s infinite;
    }

    @keyframes markerPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
  </style>
</head>

<body class="vertical-layout page-header-light vertical-menu-collapsible vertical-dark-menu preload-transitions 2-columns"
      data-open="click" data-menu="vertical-dark-menu" data-col="2-columns">

 <%- include('_layouts/sidenavbar') %>

  <div id="main">
    <div class="row dashboard">
      <div class="col s12">
        <div class="container">
          <div class="section">
            <div id="card-stats" class="pt-0">
              <div class="row">
                <%- include('messages', { messages: messages }) %>
              </div>

              <!-- Stats Cards -->
              <div class="row mt-2">
                <div class="col m3 s12" style="padding: 10px;">
                  <a href="/admin/deliveries?status=delivered&date=today" style="text-decoration: none;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #00C853, #009624); border-radius: 16px; padding: 24px 20px;">
                      <h4 class="counter white-text" style="font-size: 42px; font-weight: 800; margin: 0;" data-target="<%= stats.todayDeliveries || 0 %>">0</h4>
                      <span class="white-text" style="font-size: 18px;">Today's Deliveries</span>
                    </div>
                  </a>
                </div>

                <div class="col m3 s12" style="padding: 10px;">
                  <a href="/admin/drivers?status=available" style="text-decoration: none;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #3F51B5, #303F9F); border-radius: 16px; padding: 24px 20px;">
                      <h4 class="counter white-text" style="font-size: 42px; font-weight: 800; margin: 0;" data-target="<%= stats.availableDrivers || 0 %>">0</h4>
                      <span class="white-text" style="font-size: 18px;">Available Drivers</span>
                    </div>
                  </a>
                </div>

                <div class="col m3 s12" style="padding: 10px;">
                  <a href="/admin/vehicles?status=available" style="text-decoration: none;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #FF6D00, #EF6C00); border-radius: 16px; padding: 24px 20px;">
                      <h4 class="counter white-text" style="font-size: 42px; font-weight: 800; margin: 0;" data-target="<%= stats.availableVehicles || 0 %>">0</h4>
                      <span class="white-text" style="font-size: 18px;">Available Vehicles</span>
                    </div>
                  </a>
                </div>

                <div class="col m3 s12" style="padding: 10px;">
                  <a href="/admin/orders" style="text-decoration: none;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #1A9CFF, #1976D2); border-radius: 16px; padding: 24px 20px;">
                      <h4 class="counter white-text" style="font-size: 42px; font-weight: 800; margin: 0;" data-target="<%= stats.totalOrders || 0 %>">0</h4>
                      <span class="white-text" style="font-size: 18px;">Total Orders</span>
                    </div>
                  </a>
                </div>
              </div>
            </div>

            <!-- Live Drivers Map Section -->
            <div class="row mt-4">
              <div class="col s12">
                <div class="card map-card z-depth-3">
                  <div class="card-content" style="padding: 28px 32px;">
                    <div class="row valign-wrapper" style="margin-bottom: 20px;">
                      <div class="col s12 m6">
                        <h5 style="margin: 0; font-weight: 700; color: #212121;">
                          <i class="material-icons left">location_on</i>
                          Live Driver Tracking
                        </h5>
                        <p style="margin: 6px 0 0; color: #757575;">
                          Real-time location of all active drivers
                        </p>
                      </div>
                      <div class="col s12 m6 right-align">
                        <span id="activeDriversCount" class="badge blue white-text" style="padding: 8px 16px; border-radius: 20px; font-size: 14px;">
                          0 Drivers Online
                        </span>
                        <span id="lastUpdateTime" class="grey-text" style="margin-left: 15px; font-size: 12px;">
                          Last updated: Never
                        </span>
                      </div>
                    </div>

                    <!-- Map Container -->
                    <div style="position: relative;">
                      <div id="driversMap"></div>
                      
                      <div class="live-badge">
                        <span class="live-pulse-dot"></span>
                        <span>LIVE TRACKING</span>
                      </div>

                      <div class="map-controls">
                        <button class="map-control-btn active" id="showAllBtn" onclick="showAllDrivers()">
                          <i class="material-icons tiny">visibility</i> All
                        </button>
                        <button class="map-control-btn" id="showInTransitBtn" onclick="filterDrivers('In_transit')">
                          <i class="material-icons tiny">local_shipping</i> In Transit
                        </button>
                        <button class="map-control-btn" id="showAvailableBtn" onclick="filterDrivers('available')">
                          <i class="material-icons tiny">check_circle</i> Available
                        </button>
                      </div>
                    </div>

                    <!-- Driver Legend -->
                    <div class="driver-legend">
                      <strong style="margin-right: 15px;">Driver Status:</strong>
                      <div class="legend-item">
                        <span class="legend-dot available"></span>
                        <span>Available (<span id="availableCount">0</span>)</span>
                      </div>
                      <div class="legend-item">
                        <span class="legend-dot in-transit"></span>
                        <span>In Transit (<span id="inTransitCount">0</span>)</span>
                      </div>
                      <div class="legend-item">
                        <span class="legend-dot offline"></span>
                        <span>Offline (<span id="offlineCount">0</span>)</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Performance Graph -->
            <div class="row mt-4">
              <div class="col s12">
                <div class="card z-depth-3" style="border-radius: 16px; overflow: hidden;">
                  <div class="card-content" style="padding: 28px 32px;">
                    <h5 style="margin: 0 0 20px 0; font-weight: 700;">Weekly Performance Overview</h5>
                    <div style="position: relative; height: 380px;">
                      <canvas id="modernTrendChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <%- include('_layouts/commonJs') %>

  <!-- Google Maps API -->
  <script>
    const GOOGLE_MAPS_API_KEY = '<%= process.env.GOOGLE_MAPS_API_KEY || "YOUR_API_KEY" %>';
    
    (function() {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initDriversMap`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    })();
  </script>

  <script>
    let driversMap, socket;
    let driverMarkers = {};
    let driverData = {};
    let currentFilter = 'all';
    let polylines = {};  // Store route polylines for each driver

    function initDriversMap() {
      const defaultCenter = { lat: 23.0225, lng: 72.5714 };

      driversMap = new google.maps.Map(document.getElementById('driversMap'), {
        center: defaultCenter,
        zoom: 12,
        mapTypeControl: true,
        streetViewControl: false,
        fullscreenControl: true,
        styles: [
          {
            featureType: 'poi',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }]
          }
        ]
      });

      console.log('‚úÖ Drivers Map Initialized');
      initializeDriverSocket();
      fetchAllDriverLocations();
    }

    function initializeDriverSocket() {
      const socketUrl = '<%= process.env.FRONTEND_URL || "http://localhost:8000" %>';
      socket = io(socketUrl, {
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5
      });

      socket.on('connect', () => {
        console.log('‚úÖ Socket connected:', socket.id);
        socket.emit('join-admin-room');
        M.toast({ html: 'üü¢ Live tracking connected', classes: 'green' });
      });

      socket.on('disconnect', () => {
        console.log('‚ùå Socket disconnected');
        M.toast({ html: 'üî¥ Live tracking disconnected', classes: 'red' });
      });

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ REAL-TIME LOCATION UPDATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      socket.on('driver:location:update', (data) => {
        console.log('üìç Driver location update:', data);
        updateDriverMarker(data);
        updateLastUpdateTime();
      });

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ JOURNEY STARTED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      socket.on('driver:journey:started', (data) => {
        console.log('üöÄ Driver journey started:', data);
        updateDriverMarker(data);
        M.toast({ 
          html: `üöÄ ${data.driverName} started journey`, 
          classes: 'blue' 
        });
      });

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ JOURNEY ENDED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      socket.on('driver:journey:ended', (data) => {
        console.log('‚úÖ Driver journey ended:', data);
        updateDriverMarker(data);
        M.toast({ 
          html: `‚úÖ ${data.driverName} completed journey`, 
          classes: 'green' 
        });
      });

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STATUS CHANGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      socket.on('driver:status:change', (data) => {
        console.log('üîÑ Driver status change:', data);
        updateDriverStatus(data);
      });
    }

    async function fetchAllDriverLocations() {
      try {
        const response = await fetch('/admin/api/drivers/locations');
        const result = await response.json();

        if (result.success && result.data) {
          result.data.forEach(driver => {
            if (driver.currentLocation?.latitude && driver.currentLocation?.longitude) {
              updateDriverMarker({
                driverId: driver._id,
                driverName: driver.name,
                vehicleNumber: driver.vehicleNumber || 'N/A',
                location: driver.currentLocation,
                isAvailable: driver.isAvailable,
                status: driver.currentJourney ? 'In_transit' : (driver.isAvailable ? 'available' : 'offline')
              });
            }
          });

          updateDriverCounts();
          fitMapToDrivers();
          updateLastUpdateTime();
        }
      } catch (error) {
        console.error('Failed to fetch driver locations:', error);
        M.toast({ html: '‚ùå Failed to load drivers', classes: 'red' });
      }
    }

    function updateDriverMarker(data) {
      const { driverId, driverName, vehicleNumber, location, isAvailable, status, journeyId } = data;

      if (!location?.latitude || !location?.longitude) {
        console.warn('Invalid location for driver:', driverId);
        return;
      }

      const position = { lat: location.latitude, lng: location.longitude };
      
      // Determine marker color based on status
      let markerColor = 'grey';
      let statusText = 'Offline';
      
      if (status === 'In_transit' || status === 'In_progress' || status === 'Started') {
        markerColor = 'orange';
        statusText = 'In Transit';
      } else if (isAvailable || status === 'available') {
        markerColor = 'green';
        statusText = 'Available';
      }

      if (driverMarkers[driverId]) {
        // Update existing marker
        const oldPosition = driverMarkers[driverId].getPosition();
        driverMarkers[driverId].setPosition(position);
        driverMarkers[driverId].setIcon({
          url: `http://maps.google.com/mapfiles/ms/icons/${markerColor}-dot.png`,
          scaledSize: new google.maps.Size(40, 40)
        });

        // Draw route line if driver is moving
        if (oldPosition && status === 'In_transit') {
          drawRouteLine(driverId, oldPosition, position);
        }
      } else {
        // Create new marker
        const marker = new google.maps.Marker({
          position: position,
          map: driversMap,
          title: driverName || 'Driver',
          icon: {
            url: `http://maps.google.com/mapfiles/ms/icons/${markerColor}-dot.png`,
            scaledSize: new google.maps.Size(40, 40)
          },
          animation: google.maps.Animation.DROP
        });

        const infoContent = `
          <div style="padding: 12px; min-width: 200px;">
            <h6 style="margin: 0 0 10px 0; color: #1976D2; font-weight: 600;">
              ${driverName || 'Driver'}
            </h6>
            <p style="margin: 5px 0;">
              <strong>üöó Vehicle:</strong> ${vehicleNumber || 'N/A'}
            </p>
            <p style="margin: 5px 0;">
              <strong>üìç Status:</strong> 
              <span style="color: ${markerColor === 'green' ? '#4CAF50' : markerColor === 'orange' ? '#FF9800' : '#9E9E9E'}; font-weight: 600;">
                ${statusText}
              </span>
            </p>
            ${location.address ? `<p style="margin: 5px 0; font-size: 11px; color: #666;">${location.address}</p>` : ''}
            <p style="margin: 5px 0; font-size: 11px; color: #999;">
              Updated: ${new Date(location.lastUpdated || Date.now()).toLocaleTimeString()}
            </p>
          </div>
        `;

        const infoWindow = new google.maps.InfoWindow({
          content: infoContent
        });

        marker.addListener('click', () => {
          Object.values(driverMarkers).forEach(m => {
            if (m.infoWindow) m.infoWindow.close();
          });
          infoWindow.open(driversMap, marker);
        });

        marker.infoWindow = infoWindow;
        driverMarkers[driverId] = marker;
      }

      // Update driver data
      driverData[driverId] = {
        name: driverName,
        vehicleNumber: vehicleNumber,
        status: statusText,
        location: location,
        journeyId: journeyId || null
      };

      updateDriverCounts();
      applyCurrentFilter();
    }

    function drawRouteLine(driverId, oldPosition, newPosition) {
      // Remove old polyline if exists
      if (polylines[driverId]) {
        polylines[driverId].setMap(null);
      }

      // Draw new polyline
      const path = [oldPosition, newPosition];
      const polyline = new google.maps.Polyline({
        path: path,
        geodesic: true,
        strokeColor: '#2196F3',
        strokeOpacity: 0.7,
        strokeWeight: 3,
        map: driversMap
      });

      polylines[driverId] = polyline;

      // Remove after 30 seconds
      setTimeout(() => {
        if (polylines[driverId]) {
          polylines[driverId].setMap(null);
          delete polylines[driverId];
        }
      }, 30000);
    }

    function updateDriverStatus(data) {
      const { driverId, isAvailable, status, journeyId } = data;

      if (driverData[driverId]) {
        const statusText = status === 'In_transit' ? 'In Transit' : 
                          (isAvailable ? 'Available' : 'Offline');
        
        driverData[driverId].status = statusText;
        driverData[driverId].journeyId = journeyId || null;
        
        const marker = driverMarkers[driverId];
        if (marker) {
          const markerColor = status === 'In_transit' ? 'orange' : 
                              (isAvailable ? 'green' : 'grey');
          marker.setIcon({
            url: `http://maps.google.com/mapfiles/ms/icons/${markerColor}-dot.png`,
            scaledSize: new google.maps.Size(40, 40)
          });
        }

        updateDriverCounts();
        applyCurrentFilter();
      }
    }

    function updateDriverCounts() {
      let available = 0, inTransit = 0, offline = 0, total = 0;

      Object.values(driverData).forEach(driver => {
        total++;
        if (driver.status === 'Available') available++;
        else if (driver.status === 'In Transit') inTransit++;
        else offline++;
      });

      document.getElementById('activeDriversCount').textContent = `${total} Drivers Online`;
      document.getElementById('availableCount').textContent = available;
      document.getElementById('inTransitCount').textContent = inTransit;
      document.getElementById('offlineCount').textContent = offline;
    }

    function updateLastUpdateTime() {
      const now = new Date();
      document.getElementById('lastUpdateTime').textContent = 
        `Last updated: ${now.toLocaleTimeString()}`;
    }

    function fitMapToDrivers() {
      const bounds = new google.maps.LatLngBounds();
      let hasDrivers = false;

      Object.values(driverMarkers).forEach(marker => {
        if (marker.getMap()) {
          bounds.extend(marker.getPosition());
          hasDrivers = true;
        }
      });

      if (hasDrivers) {
        driversMap.fitBounds(bounds);
      }
    }

    function showAllDrivers() {
      currentFilter = 'all';
      Object.values(driverMarkers).forEach(marker => marker.setMap(driversMap));
      updateFilterButtons('showAllBtn');
      fitMapToDrivers();
    }

    function filterDrivers(statusFilter) {
      currentFilter = statusFilter;
      
      Object.entries(driverMarkers).forEach(([driverId, marker]) => {
        const driver = driverData[driverId];
        
        const shouldShow = 
          (statusFilter === 'available' && driver?.status === 'Available') ||
          (statusFilter === 'In_transit' && driver?.status === 'In Transit');
        
        marker.setMap(shouldShow ? driversMap : null);
      });

      const btnId = statusFilter === 'available' ? 'showAvailableBtn' : 'showInTransitBtn';
      updateFilterButtons(btnId);
      fitMapToDrivers();
    }

    function applyCurrentFilter() {
      if (currentFilter === 'all') {
        showAllDrivers();
      } else {
        filterDrivers(currentFilter);
      }
    }

    function updateFilterButtons(activeId) {
      document.querySelectorAll('.map-control-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(activeId).classList.add('active');
    }

    // Counter Animation & Chart
    document.addEventListener('DOMContentLoaded', () => {
      // Counter animation
      const counters = document.querySelectorAll('.counter');
      counters.forEach(counter => {
        const target = +counter.getAttribute('data-target');
        let count = 0;
        const speed = 100;

        const updateCounter = () => {
          const increment = target / speed;
          if (count < target) {
            count += increment;
            counter.textContent = Math.ceil(count).toLocaleString();
            setTimeout(updateCounter, 20);
          } else {
            counter.textContent = target.toLocaleString();
          }
        };

        updateCounter();
      });

      // Chart
      const ctx = document.getElementById('modernTrendChart').getContext('2d');
      const chartData = <%- JSON.stringify(chartData) %> || [];

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.map(item => item._id) || [],
          datasets: [
            {
              label: 'Orders',
              data: chartData.map(item => item.orders || 0),
              borderColor: '#1A9CFF',
              backgroundColor: 'rgba(26, 156, 255, 0.12)',
              borderWidth: 4,
              tension: 0.45,
              fill: true
            },
            {
              label: 'Deliveries',
              data: chartData.map(item => item.deliveries || 0),
              borderColor: '#00C853',
              backgroundColor: 'rgba(0, 200, 83, 0.12)',
              borderWidth: 4,
              tension: 0.45,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { 
              display: true,
              position: 'top'
            } 
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    });

    // Refresh driver locations every 30 seconds
    setInterval(() => {
      fetchAllDriverLocations();
    }, 30000);
  </script>
</body>
</html>
