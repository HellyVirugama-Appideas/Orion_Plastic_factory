<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">

<head>
    <%- include('_layouts/head') %>
    <title>Driver Details | <%= title %></title>
    <link rel="stylesheet" type="text/css" href="/app-assets/css/pages/page-users.css">
    <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/extensions/responsive/css/responsive.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/select.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="/app-assets/css/pages/data-tables.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        table tr td, th {
            text-align: center;
        }

        [type='checkbox']+span:not(.lever):before {
            border-color: black;
        }

        [type='checkbox']:checked+span:not(.lever):before {
            border-right-color: black;
            border-bottom-color: black;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        .switch label input[type=checkbox]:not(:checked)+.lever {
            background-color: #f3374a;
        }

        .switch label input[type=checkbox]:not(:checked)+.lever::before {
            background-color: #ffaba5;
        }

        .switch label input[type=checkbox]:checked+.lever {
            background-color: #31db37;
        }

        .switch label input[type=checkbox]:checked+.lever::before {
            background-color: #4CAF50;
        }

        /* Responsive fixes */
        @media (max-width: 768px) {
            .commission-section {
                flex-direction: column !important;
                align-items: flex-end !important;
                gap: 15px !important;
            }
        }
    </style>
</head>

<body class="vertical-layout page-header-light vertical-menu-collapsible vertical-dark-menu preload-transitions 2-columns"
      data-open="click" data-menu="vertical-dark-menu" data-col="2-columns">

    <%- include('_layouts/sidenavbar') %>

    <div id="main">
        <div class="row">
            <!-- Breadcrumbs -->
            <div id="breadcrumbs-wrapper" style="background-color: white;">
                <div class="container">
                    <div class="row">
                        <div class="col s12 m6 l6">
                            <h5 class="breadcrumbs-title"><span>Driver Details</span></h5>
                        </div>
                        <div class="col s12 m6 l6 right-align-md">
                            <a class="btn gradient-45deg-purple-deep-orange pull-right btn-breadcrumbs modal-trigger"
                               href="#modal">Send Notification</a>
                        </div>
                    </div>
                </div>
            </div>

            <%- include('messages', { messages: messages }) %>

            <div class="col s12">
                <div class="container">
                    <div class="section users-view">

                        <!-- HEADER CARD -->
                        <div class="card-panel">
                            <div class="row">
                                <div class="col s12 m7">
                                    <div class="display-flex media">
                                        <img src="<%= driver.profileImage || '/img/avatar.png' %>" alt="Profile"
                                             height="64" width="64" style="border-radius: 50%;">
                                        <div class="media-body" style="margin-left: 10px;">
                                            <h5><%= driver.name || 'Driver' %></h5>
                                            <span>Phone:</span>
                                            <span class="users-view-id"><a href="tel:<%= driver.phone %>"><%= driver.phone || 'N/A' %></a></span><br>
                                            <span>Email:</span>
                                            <span class="users-view-id"><a href="mailto:<%= driver.email %>"><%= driver.email || 'N/A' %></a></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- RIGHT SIDE: STATUS TOGGLE + ACTIONS -->
                                <div class="col s12 m5" style="text-align: right;">
                                    <div class="commission-section"
                                         style="display: flex; align-items: center; justify-content: flex-end; gap: 20px; flex-wrap: wrap;">

                                        <!-- Profile Status Toggle (Approve / Reject) -->
                                        <div class="switch">
                                            <label>
                                                <span style="color: #f44336; font-weight: bold;">Rejected</span>
                                                <input type="checkbox" <%= driver.profileStatus === 'approved' ? 'checked' : '' %>
                                                       onchange="toggleProfileStatus('<%= driver._id %>', this.checked)">
                                                <span class="lever" style="background-color: #4CAF50;"></span>
                                                <span style="color: #4CAF50; font-weight: bold;">Approved</span>
                                            </label>
                                        </div>

                                        <!-- Current Profile Status Badge -->
                                        <span class="badge <%= driver.profileStatus === 'approved' ? 'green white-text' : 
                                                              driver.profileStatus === 'rejected' ? 'red white-text' : 
                                                              'orange white-text' %>">
                                            <%= driver.profileStatus === 'approved' ? 'APPROVED' : 
                                                driver.profileStatus === 'rejected' ? 'REJECTED' : 'PENDING' %>
                                        </span>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                                        <a href="/admin/drivers/live-tracking/<%= driver._id %>"
                                           class="btn-small indigo waves-effect waves-light">
                                            Live Tracking
                                        </a>
                                        <a href="/admin/drivers/logs/<%= driver._id %>"
                                           class="btn-small blue waves-effect waves-light">
                                            View Activity
                                        </a>
                                        <a href="/admin/drivers/edit/<%= driver._id %>"
                                           class="btn-small blue waves-effect waves-light">
                                            Edit
                                        </a>
                                        <a href="/admin/drivers/delete/<%= driver._id %>"
                                           class="btn-small red waves-effect waves-light"
                                           onclick="return confirm('Delete this driver?');">
                                            Delete
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Driver Basic Information -->
                        <div class="card">
                            <div class="card-content">
                                <h5>Driver Basic Information</h5>
                                <div class="row">
                                    <div class="col s12 m6">
                                        <table class="striped">
                                            <tbody>
                                                <tr><th style="width: 200px;">Name</th><td><%= driver.name || '-' %></td></tr>
                                                <tr><th>Phone</th><td><%= driver.phone || '-' %></td></tr>
                                                <tr><th>Email</th><td><%= driver.email || '-' %></td></tr>
                                                <tr><th>Vehicle Number</th><td><%= driver.vehicleNumber || 'Not Assigned' %></td></tr>
                                                <tr><th>Joined Date</th><td><%= driver.createdAt ? new Date(driver.createdAt).toLocaleDateString('en-IN') : '-' %></td></tr>
                                                <tr><th>Status</th><td><span class="badge <%= driver.isActive ? 'green white-text' : 'red white-text' %>"><%= driver.isActive ? 'Active' : 'Inactive' %></span></td></tr>
                                                <tr>
                                                    <th>Profile Approval</th>
                                                    <td>
                                                        <span class="badge <%= driver.profileStatus === 'approved' ? 'green white-text' : 
                                                                              driver.profileStatus === 'rejected' ? 'red white-text' : 
                                                                              'orange white-text' %>">
                                                            <%= driver.profileStatus.toUpperCase() %>
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col s12 m6">
                                        <div class="row">
                                            <div class="col s6">
                                                <h6>Profile Image</h6>
                                                <img src="<%= driver.profileImage || '/img/avatar.png' %>" style="width: 100%; border-radius: 8px;" />
                                            </div>
                                            <div class="col s6">
                                                <h6>License / Other Doc (Sample)</h6>
                                                <img src="<%= driver.licenseImage || '/img/placeholder-doc.png' %>" style="width: 100%; border-radius: 8px;" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Documents Section - View Button Only -->
                        <div class="card">
                            <div class="card-content">
                                <h5>Documents</h5>
                                <p>All documents (License Front/Back, RC Front/Back, etc.) with verification status are available on the dedicated page.</p>
                                <a href="/admin/drivers/documents/<%= driver._id %>" 
                                   class="btn blue waves-effect waves-light">
                                    <i class="material-icons left">description</i> View All Documents & Status
                                </a>
                            </div>
                        </div>

                        <!-- Recent Deliveries -->
                        <div class="row">
                            <div class="col s12">
                                <h5>Recent Deliveries (Last 10)</h5>
                            </div>
                            <div class="col s12" style="padding: 0%;">
                                <div class="section section-data-tables">
                                    <div class="col s12">
                                        <div class="card">
                                            <div class="card-content">
                                                <div class="row">
                                                    <div class="col s12 overflow">
                                                        <table id="deliveries-table" class="display">
                                                            <thead>
                                                                <tr>
                                                                    <th>Sr</th>
                                                                    <th>Order ID</th>
                                                                    <th>Status</th>
                                                                    <th>Date</th>
                                                                    <th>Distance</th>
                                                                    <th>Amount Earned</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <% if (recentDeliveries && recentDeliveries.length > 0) { %>
                                                                    <% recentDeliveries.forEach((delivery, index) => { %>
                                                                        <tr>
                                                                            <td><%= index + 1 %></td>
                                                                            <td><%= delivery.orderId?.orderNumber || 'N/A' %></td>
                                                                            <td>
                                                                                <span class="badge <%= delivery.status === 'delivered' ? 'green' : 'orange' %>">
                                                                                    <%= delivery.status %>
                                                                                </span>
                                                                            </td>
                                                                            <td><%= new Date(delivery.createdAt).toLocaleDateString('en-IN') %></td>
                                                                            <td><%= delivery.distance || 'N/A' %> km</td>
                                                                            <td><%= delivery.earnings || 'N/A' %> â‚¹</td>
                                                                        </tr>
                                                                    <% }) %>
                                                                <% } else { %>
                                                                    <tr>
                                                                        <td colspan="6" class="center-align">No recent deliveries</td>
                                                                    </tr>
                                                                <% } %>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bank Details & Performance Stats -->
                        <div class="row">
                            <div class="col s12">
                                <h5>Bank Details & Performance Stats</h5>
                            </div>
                            <div class="col s12" style="padding: 0%;">
                                <div class="section section-data-tables">
                                    <div class="col s12">
                                        <div class="card">
                                            <div class="card-content">
                                                <div class="row">
                                                    <div class="col s12 overflow">
                                                        <table class="striped">
                                                            <tbody>
                                                                <tr><th>Total Rides / Deliveries</th><td><%= stats.totalDeliveries || 0 %></td></tr>
                                                                <tr><th>Completed Deliveries</th><td><%= stats.completed || 0 %></td></tr>
                                                                <tr><th>Active / In-Progress</th><td><%= stats.active || 0 %></td></tr>
                                                                <tr><th>Average Rating / Reviews</th><td>N/A (Coming Soon)</td></tr>
                                                                <tr><th>Bank Holder Name</th><td><%= driver.bankDetails?.accountHolderName || '-' %></td></tr>
                                                                <tr><th>Account Number</th><td><%= driver.bankDetails?.accountNumber || '-' %></td></tr>
                                                                <tr><th>IFSC Code</th><td><%= driver.bankDetails?.ifscCode || '-' %></td></tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Live Tracking Section -->
                        <div class="card">
                            <div class="card-content">
                                <h5>Live Tracking</h5>
                                <p>Click below to view real-time location of this driver.</p>
                                <a href="/admin/drivers/live-tracking/<%= driver._id %>"
                                   class="btn indigo waves-effect waves-light">
                                    Open Live Tracking
                                </a>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <%- include('_layouts/commonJs') %>
        <script src="/app-assets/vendors/data-tables/js/jquery.dataTables.min.js"></script>
        <script src="/app-assets/js/scripts/data-tables.js"></script>

        <script>
            $(document).ready(function () {
                $('.modal').modal();
                $('#deliveries-table').DataTable({ responsive: true });
            });

            function toggleProfileStatus(driverId, isApproved) {
                const action = isApproved ? 'approve' : 'reject';
                const message = isApproved
                    ? "Are you sure you want to APPROVE this driver's profile?"
                    : "Are you sure you want to REJECT this driver's profile?";

                if (confirm(message)) {
                    window.location.href = `/admin/drivers/profile-status/${driverId}/${isApproved ? '1' : '0'}`;
                } else {
                    location.reload();
                }
            }
        </script>
</body>

</html>