<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">

<head>
    <%- include('_layouts/head') %>
        <title>Customer Details | <%= title %>
        </title>

        <link rel="stylesheet" type="text/css" href="/app-assets/css/pages/page-users.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/jquery.dataTables.min.css">
        <link rel="stylesheet" type="text/css"
            href="/app-assets/vendors/data-tables/extensions/responsive/css/responsive.dataTables.min.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/select.dataTables.min.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/css/pages/data-tables.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <style>
            table tr td,
            th {
                text-align: center;
            }

            [type='checkbox']+span:not(.lever):before {
                border-color: black;
            }

            [type='checkbox']:checked+span:not(.lever):before {
                border-right-color: black;
                border-bottom-color: black;
            }

            .badge {
                padding: 5px 10px;
                border-radius: 12px;
                font-size: 12px;
            }

            .users-view-id {
                color: #2196F3;
                font-weight: 500;
            }

            /* Responsive fixes */
            @media (max-width: 768px) {
                .commission-section {
                    flex-direction: column !important;
                    align-items: flex-end !important;
                    gap: 15px !important;
                }
            }
        </style>
</head>

<body
    class="vertical-layout page-header-light vertical-menu-collapsible vertical-dark-menu preload-transitions 2-columns"
    data-open="click" data-menu="vertical-dark-menu" data-col="2-columns">

    <%- include('_layouts/sidenavbar') %>

        <div id="main">
            <div class="row">
                <!-- Breadcrumbs -->
                <div id="breadcrumbs-wrapper" style="background-color: white;">
                    <div class="container">
                        <div class="row">
                            <div class="col s12 m6 l6">
                                <h5 class="breadcrumbs-title"><span>Customer Details</span></h5>
                            </div>
                            <div class="col s12 m6 l6 right-align-md" style="margin-top: -10px;">
                                <ol class="breadcrumbs mb-0">
                                    <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
                                    <li class="breadcrumb-item active"><a href="/admin/customers">Customers</a></li>
                                    <li class="breadcrumb-item active">View</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <%- include('messages', { messages: messages }) %>

                    <div class="col s12">
                        <div class="container">
                            <div class="section users-view">

                                <!-- HEADER CARD -->
                                <div class="card-panel">
                                    <div class="row">
                                        <div class="col s12 m7">
                                            <div class="display-flex media">
                                                <!-- You can add customer profile image here later -->
                                                <img src="/img/avatar.png" alt="Customer" height="64" width="64"
                                                    style="border-radius: 50%;">
                                                <div class="media-body" style="margin-left: 10px;">
                                                    <h5>
                                                        <%= customer.companyName || customer.name || 'Customer' %>
                                                    </h5>
                                                    <span>Phone:</span>
                                                    <span class="users-view-id">
                                                        <a href="tel:<%= customer.phone %>">
                                                            <%= customer.phone || 'N/A' %>
                                                        </a>
                                                    </span><br>
                                                    <span>Email:</span>
                                                    <span class="users-view-id">
                                                        <a href="mailto:<%= customer.email %>">
                                                            <%= customer.email || 'N/A' %>
                                                        </a>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- RIGHT SIDE: ACTIONS -->
                                        <div class="col s12 m5" style="text-align: right;">
                                            <div class="commission-section"
                                                style="display: flex; align-items: center; justify-content: flex-end; gap: 20px; flex-wrap: wrap;">

                                                <!-- Current Status Badge -->
                                                <span
                                                    class="badge <%= customer.status === 'active' ? 'green white-text' : 'red white-text' %>">
                                                    <%= customer.status?.toUpperCase() || 'UNKNOWN' %>
                                                </span>

                                                <!-- Action Buttons -->
                                                <div
                                                    style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                                                    <a href="/admin/customers/<%= customer._id %>/edit"
                                                        class="btn-small blue waves-effect waves-light">
                                                        Edit
                                                    </a>
                                                    <a href="#" class="btn-small red waves-effect waves-light"
                                                        onclick="confirmDelete('<%= customer._id %>', '<%= customer.name || customer.companyName %>')">
                                                        Delete
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Customer Basic Information -->
                                <div class="card">
                                    <div class="card-content">
                                        <h5>Customer Basic Information</h5>
                                        <div class="row">
                                            <div class="col s12 m6">
                                                <table class="striped">
                                                    <tbody>
                                                        <tr>
                                                            <th style="width: 200px;">Customer ID</th>
                                                            <td>
                                                                <%= customer.customerId || 'N/A' %>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Name</th>
                                                            <td>
                                                                <%= customer.name || '-' %>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Company Name</th>
                                                            <td>
                                                                <%= customer.companyName || 'N/A' %>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Type</th>
                                                            <td>
                                                                <%= customer.customerType?.toUpperCase() || 'INDIVIDUAL'
                                                                    %>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Category</th>
                                                            <td>
                                                                <%= customer.category?.toUpperCase() || 'REGULAR' %>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Status</th>
                                                            <td>
                                                                <span
                                                                    class="badge <%= customer.status === 'active' ? 'green white-text' : 'red white-text' %>">
                                                                    <%= customer.status?.toUpperCase() || 'UNKNOWN' %>
                                                                </span>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Joined Date</th>
                                                            <td>
                                                                <%= customer.createdAt ? new
                                                                    Date(customer.createdAt).toLocaleDateString('en-IN')
                                                                    : '-' %>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="col s12 m6">
                                                <div class="row">
                                                    <!-- You can add profile/company logo here later -->
                                                    <div class="col s12 center-align">
                                                        <h6>Customer Logo / Image</h6>
                                                        <img src="/img/placeholder-company.png"
                                                            style="max-width: 100%; border-radius: 8px;" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Primary Address -->
                                <div class="card">
                                    <div class="card-content">
                                        <h5><i class="material-icons">location_on</i> Primary Address</h5>
                                        <p><strong>
                                                <%= primaryLocation.locationName || 'Main Location' %>
                                            </strong></p>
                                        <p>
                                            <%= primaryLocation.addressLine1 || 'N/A' %>
                                        </p>
                                        <% if (primaryLocation.addressLine2) { %>
                                            <p>
                                                <%= primaryLocation.addressLine2 %>
                                            </p>
                                            <% } %>
                                                <p>
                                                    <%= primaryLocation.city %>, <%= primaryLocation.state %>
                                                            <%= primaryLocation.zipcode %>
                                                </p>
                                                <p>Country: <%= primaryLocation.country || 'India' %>
                                                </p>
                                    </div>
                                </div>

                                <!-- Documents Section -->
                                <div class="card">
                                    <div class="card-content">
                                        <h5><i class="material-icons">attach_file</i> Documents</h5>
                                        <div class="row">
                                            <% const docs=[ { name: 'GST Certificate' , url: customer.gstCertificate },
                                                { name: 'PAN Card' , url: customer.panCard }, { name: 'Shop License' ,
                                                url: customer.shopLicense }, { name: 'Other Document' , url:
                                                customer.otherDoc } ]; %>

                                                <% docs.forEach(doc=> { %>
                                                    <% if (doc.url) { %>
                                                        <div class="col s12 m6 l3">
                                                            <div class="card-panel hoverable">
                                                                <p><strong>
                                                                        <%= doc.name %>
                                                                    </strong></p>
                                                                <a href="<%= doc.url %>" target="_blank"
                                                                    class="btn-small blue">
                                                                    <i class="material-icons left">picture_as_pdf</i>
                                                                    View
                                                                </a>
                                                            </div>
                                                        </div>
                                                        <% } %>
                                                            <% }) %>

                                                                <% if (!customer.gstCertificate && !customer.panCard &&
                                                                    !customer.shopLicense && !customer.otherDoc) { %>
                                                                    <div class="col s12">
                                                                        <p class="grey-text">No documents uploaded yet.
                                                                        </p>
                                                                    </div>
                                                                    <% } %>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recent Deliveries -->
                                <div class="row">
                                    <div class="col s12">
                                        <h5>Recent Deliveries (Last 10)</h5>
                                    </div>
                                    <div class="col s12" style="padding: 0%;">
                                        <div class="section section-data-tables">
                                            <div class="col s12">
                                                <div class="card">
                                                    <div class="card-content">
                                                        <div class="row">
                                                            <div class="col s12 overflow">
                                                                <table id="deliveries-table" class="display">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Sr</th>
                                                                            <th>Order ID</th>
                                                                            <th>Status</th>
                                                                            <th>Date</th>
                                                                            <th>Amount</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <% if (recentDeliveries &&
                                                                            recentDeliveries.length> 0) { %>
                                                                            <% recentDeliveries.forEach((delivery,
                                                                                index)=> { %>
                                                                                <tr>
                                                                                    <td>
                                                                                        <%= index + 1 %>
                                                                                    </td>
                                                                                    <td>
                                                                                        <%= delivery.orderId?.orderNumber
                                                                                            || 'N/A' %>
                                                                                    </td>
                                                                                    <td>
                                                                                        <span
                                                                                            class="badge <%= delivery.status === 'delivered' ? 'green' : 'orange' %>">
                                                                                            <%= delivery.status.toUpperCase()
                                                                                                %>
                                                                                        </span>
                                                                                    </td>
                                                                                    <td>
                                                                                        <%= new
                                                                                            Date(delivery.createdAt).toLocaleDateString('en-IN')
                                                                                            %>
                                                                                    </td>
                                                                                    <td>₹ <%=
                                                                                            delivery.amount?.toLocaleString()
                                                                                            || 'N/A' %>
                                                                                    </td>
                                                                                </tr>
                                                                                <% }) %>
                                                                                    <% } else { %>
                                                                                        <tr>
                                                                                            <td colspan="5"
                                                                                                class="center-align">No
                                                                                                recent deliveries</td>
                                                                                        </tr>
                                                                                        <% } %>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Statistics -->
                                <div class="card">
                                    <div class="card-content">
                                        <h5>Statistics</h5>
                                        <table class="striped">
                                            <tbody>
                                                <tr>
                                                    <th>Total Orders</th>
                                                    <td>
                                                        <%= stats.totalOrders || 0 %>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Completed Deliveries</th>
                                                    <td>
                                                        <%= stats.completed || 0 %>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Pending Orders</th>
                                                    <td>
                                                        <%= stats.pending || 0 %>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Total Spent</th>
                                                    <td>₹ <%= stats.totalSpent?.toLocaleString() || '0' %>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Last Order Date</th>
                                                    <td>
                                                        <%= stats.lastOrderDate || 'Never' %>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
            </div>

            <%- include('_layouts/commonJs') %>
                <script src="/app-assets/vendors/data-tables/js/jquery.dataTables.min.js"></script>
                <script src="/app-assets/js/scripts/data-tables.js"></script>

                <script>
                    $(document).ready(function () {
                        $('#deliveries-table').DataTable({ responsive: true });
                    });

                    function confirmDelete(customerId, customerName) {
                        if (confirm(`Are you sure you want to delete customer "${customerName}"? This action cannot be undone.`)) {
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = `/admin/customers/${customerId}/delete`;
                            document.body.appendChild(form);
                            form.submit();
                        }
                    }
                </script>
</body>

</html>