<%- include('../layouts/main', { body: `
<div class="page-header">
  <div class="page-title-row">
    <div>
      <h1 class="page-title">Deliveries</h1>
      <nav class="breadcrumb">
        <a href="/admin/dashboard">Dashboard</a>
        <i class="fas fa-chevron-right"></i>
        <span>Deliveries</span>
      </nav>
    </div>
    <div style="display: flex; gap: 12px;">
      <a href="/admin/tracking/live" class="btn btn-secondary">
        <i class="fas fa-map-marked-alt"></i>
        Live Map
      </a>
      <a href="/admin/deliveries/create" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Assign Delivery
      </a>
    </div>
  </div>
</div>

<!-- Quick Stats -->
<div class="stats-grid" style="margin-bottom: 24px;">
  <div class="stat-card">
    <div class="stat-header">
      <div class="stat-icon">
        <i class="fas fa-clock"></i>
      </div>
    </div>
    <div class="stat-value">${stats?.pending || 0}</div>
    <div class="stat-label">Pending Assignment</div>
  </div>
  
  <div class="stat-card success">
    <div class="stat-header">
      <div class="stat-icon">
        <i class="fas fa-truck-moving"></i>
      </div>
    </div>
    <div class="stat-value">${stats?.inTransit || 0}</div>
    <div class="stat-label">In Transit</div>
  </div>
  
  <div class="stat-card warning">
    <div class="stat-header">
      <div class="stat-icon">
        <i class="fas fa-shipping-fast"></i>
      </div>
    </div>
    <div class="stat-value">${stats?.outForDelivery || 0}</div>
    <div class="stat-label">Out for Delivery</div>
  </div>
  
  <div class="stat-card">
    <div class="stat-header">
      <div class="stat-icon">
        <i class="fas fa-check-circle"></i>
      </div>
    </div>
    <div class="stat-value">${stats?.delivered || 0}</div>
    <div class="stat-label">Delivered Today</div>
  </div>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: 24px;">
  <div class="card-body">
    <form method="GET" action="/admin/deliveries" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: end;">
      <div class="form-group" style="margin-bottom: 0;">
        <label class="form-label">Search</label>
        <input 
          type="text" 
          name="search" 
          class="form-control" 
          placeholder="Tracking number, driver..." 
          value="${filters?.search || ''}"
        >
      </div>
      
      <div class="form-group" style="margin-bottom: 0;">
        <label class="form-label">Status</label>
        <select name="status" class="form-control">
          <option value="">All Status</option>
          <option value="pending" ${filters?.status === 'pending' ? 'selected' : ''}>Pending</option>
          <option value="assigned" ${filters?.status === 'assigned' ? 'selected' : ''}>Assigned</option>
          <option value="picked_up" ${filters?.status === 'picked_up' ? 'selected' : ''}>Picked Up</option>
          <option value="in_transit" ${filters?.status === 'in_transit' ? 'selected' : ''}>In Transit</option>
          <option value="out_for_delivery" ${filters?.status === 'out_for_delivery' ? 'selected' : ''}>Out for Delivery</option>
          <option value="delivered" ${filters?.status === 'delivered' ? 'selected' : ''}>Delivered</option>
          <option value="failed" ${filters?.status === 'failed' ? 'selected' : ''}>Failed</option>
          <option value="returned" ${filters?.status === 'returned' ? 'selected' : ''}>Returned</option>
        </select>
      </div>
      
      <div class="form-group" style="margin-bottom: 0;">
        <label class="form-label">Driver</label>
        <select name="driver" class="form-control">
          <option value="">All Drivers</option>
          ${drivers?.map(driver => `
            <option value="${driver._id}" ${filters?.driver === driver._id.toString() ? 'selected' : ''}>
              ${driver.name}
            </option>
          `).join('')}
        </select>
      </div>
      
      <div class="form-group" style="margin-bottom: 0;">
        <label class="form-label">Date Range</label>
        <input 
          type="date" 
          name="startDate" 
          class="form-control" 
          value="${filters?.startDate || ''}"
        >
      </div>
      
      <div style="display: flex; gap: 8px;">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-filter"></i>
          Filter
        </button>
        <a href="/admin/deliveries" class="btn btn-secondary">
          <i class="fas fa-redo"></i>
          Reset
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Deliveries Table -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">All Deliveries (${deliveries.length})</h3>
    <div style="display: flex; gap: 8px;">
      <button class="btn btn-sm btn-secondary">
        <i class="fas fa-file-excel"></i>
        Export
      </button>
      <button class="btn btn-sm btn-secondary" onclick="window.print()">
        <i class="fas fa-print"></i>
        Print
      </button>
    </div>
  </div>
  <div class="card-body" style="padding: 0;">
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Tracking #</th>
            <th>Order</th>
            <th>Driver</th>
            <th>Route</th>
            <th>Status</th>
            <th>Scheduled</th>
            <th>ETA</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${deliveries.length === 0 ? `
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-light);">
                <i class="fas fa-truck" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                No deliveries found
              </td>
            </tr>
          ` : deliveries.map(delivery => `
            <tr onclick="window.location='/admin/deliveries/${delivery._id}'" style="cursor: pointer;">
              <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="font-weight: 600; color: var(--primary-color);">${delivery.trackingNumber}</span>
                  ${delivery.status === 'in_transit' ? `
                    <span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block;" title="Live"></span>
                  ` : ''}
                </div>
              </td>
              <td>
                <div>
                  <div style="font-weight: 500;">${delivery.orderId?.orderNumber || 'N/A'}</div>
                  <div style="font-size: 12px; color: var(--text-light);">${delivery.orderId?.customerId?.name || ''}</div>
                </div>
              </td>
              <td>
                ${delivery.driverId ? `
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                      ${delivery.driverId.name?.charAt(0) || 'D'}
                    </div>
                    <div>
                      <div style="font-weight: 500; font-size: 14px;">${delivery.driverId.name}</div>
                      <div style="font-size: 12px; color: var(--text-light);">${delivery.driverId.vehicleNumber || ''}</div>
                    </div>
                  </div>
                ` : `
                  <span class="badge badge-warning">Unassigned</span>
                `}
              </td>
              <td>
                <div style="font-size: 13px;">
                  <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">
                    <i class="fas fa-map-marker-alt" style="color: #10b981; font-size: 10px;"></i>
                    <span style="color: var(--text-secondary);">${delivery.pickupAddress?.city || 'N/A'}</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 4px;">
                    <i class="fas fa-map-marker-alt" style="color: #ef4444; font-size: 10px;"></i>
                    <span style="color: var(--text-secondary);">${delivery.deliveryAddress?.city || 'N/A'}</span>
                  </div>
                </div>
              </td>
              <td>
                <span class="badge badge-${getDeliveryStatusBadgeClass(delivery.status)}">
                  ${delivery.status.replace(/_/g, ' ')}
                </span>
              </td>
              <td>
                <div style="font-size: 14px;">${delivery.scheduledDate ? new Date(delivery.scheduledDate).toLocaleDateString() : 'N/A'}</div>
                <div style="font-size: 12px; color: var(--text-light);">${delivery.scheduledDate ? new Date(delivery.scheduledDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}</div>
              </td>
              <td>
                ${delivery.estimatedDeliveryTime ? `
                  <div style="font-size: 14px; font-weight: 500; color: var(--success-color);">
                    ${new Date(delivery.estimatedDeliveryTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                  </div>
                ` : `
                  <span style="font-size: 13px; color: var(--text-light);">-</span>
                `}
              </td>
              <td onclick="event.stopPropagation();">
                <div style="display: flex; gap: 4px;">
                  <a href="/admin/deliveries/${delivery._id}" class="btn btn-sm btn-secondary" title="View">
                    <i class="fas fa-eye"></i>
                  </a>
                  ${delivery.status === 'in_transit' || delivery.status === 'out_for_delivery' ? `
                    <a href="/admin/tracking/${delivery.trackingNumber}" class="btn btn-sm btn-success" title="Track">
                      <i class="fas fa-location-arrow"></i>
                    </a>
                  ` : ''}
                  ${delivery.status === 'pending' ? `
                    <a href="/admin/deliveries/${delivery._id}/assign" class="btn btn-sm btn-primary" title="Assign Driver">
                      <i class="fas fa-user-plus"></i>
                    </a>
                  ` : ''}
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pagination -->
${totalPages > 1 ? `
<div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px;">
  <a href="?page=1${Object.keys(filters || {}).map(k => '&' + k + '=' + filters[k]).join('')}" 
     class="btn btn-sm btn-secondary ${currentPage === 1 ? 'disabled' : ''}">
    <i class="fas fa-angle-double-left"></i>
  </a>
  <a href="?page=${currentPage - 1}${Object.keys(filters || {}).map(k => '&' + k + '=' + filters[k]).join('')}" 
     class="btn btn-sm btn-secondary ${currentPage === 1 ? 'disabled' : ''}">
    <i class="fas fa-angle-left"></i>
  </a>
  
  ${Array.from({length: Math.min(5, totalPages)}, (_, i) => {
    const pageNum = currentPage <= 3 ? i + 1 : currentPage + i - 2;
    return pageNum <= totalPages ? `
      <a href="?page=${pageNum}${Object.keys(filters || {}).map(k => '&' + k + '=' + filters[k]).join('')}" 
         class="btn btn-sm ${currentPage === pageNum ? 'btn-primary' : 'btn-secondary'}">
        ${pageNum}
      </a>
    ` : '';
  }).join('')}
  
  <a href="?page=${currentPage + 1}${Object.keys(filters || {}).map(k => '&' + k + '=' + filters[k]).join('')}" 
     class="btn btn-sm btn-secondary ${currentPage === totalPages ? 'disabled' : ''}">
    <i class="fas fa-angle-right"></i>
  </a>
  <a href="?page=${totalPages}${Object.keys(filters || {}).map(k => '&' + k + '=' + filters[k]).join('')}" 
     class="btn btn-sm btn-secondary ${currentPage === totalPages ? 'disabled' : ''}">
    <i class="fas fa-angle-double-right"></i>
  </a>
</div>
` : ''}

<script>
  function getDeliveryStatusBadgeClass(status) {
    const classes = {
      'pending': 'warning',
      'assigned': 'info',
      'picked_up': 'info',
      'in_transit': 'primary',
      'out_for_delivery': 'primary',
      'delivered': 'success',
      'failed': 'danger',
      'returned': 'danger',
      'cancelled': 'secondary'
    };
    return classes[status] || 'secondary';
  }
</script>
` }) %>