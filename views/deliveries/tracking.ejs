<%- include('../layouts/header') %>

<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .tracking-info-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .status-badge {
        font-size: 14px;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .live-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        background-color: #28a745;
        border-radius: 50%;
        animation: pulse 2s infinite;
        margin-right: 8px;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: #666;
    }
    
    .info-value {
        color: #333;
    }
</style>

<div class="wrapper d-flex">
    <%- include('../layouts/sidebar') %>
    
    <div class="content-wrapper flex-grow-1">
        <div class="container-fluid p-4">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-map-marked-alt"></i> Live Tracking</h2>
                    <p class="text-muted mb-0">
                        <span class="live-indicator"></span>
                        Real-time location tracking
                    </p>
                </div>
                <div>
                    <a href="/admin/deliveries/<%= delivery._id %>" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Delivery
                    </a>
                    <button class="btn btn-primary" onclick="centerMap()">
                        <i class="fas fa-crosshairs"></i> Center Map
                    </button>
                </div>
            </div>
            
            <!-- Tracking Info -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="tracking-info-card">
                        <h5 class="mb-3"><i class="fas fa-truck"></i> Delivery Information</h5>
                        <div class="info-row">
                            <span class="info-label">Tracking Number:</span>
                            <span class="info-value"><strong><%= delivery.trackingNumber %></strong></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status:</span>
                            <span class="info-value">
                                <span class="status-badge bg-<%= delivery.status === 'in_transit' ? 'primary' : delivery.status === 'out_for_delivery' ? 'warning' : 'info' %>">
                                    <%= delivery.status %>
                                </span>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Priority:</span>
                            <span class="info-value">
                                <span class="badge bg-<%= delivery.priority === 'urgent' ? 'danger' : delivery.priority === 'high' ? 'warning' : 'info' %>">
                                    <%= delivery.priority %>
                                </span>
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="tracking-info-card">
                        <h5 class="mb-3"><i class="fas fa-user-circle"></i> Driver Information</h5>
                        <% if (delivery.driverId) { %>
                            <div class="info-row">
                                <span class="info-label">Name:</span>
                                <span class="info-value"><%= delivery.driverId.userId.name %></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Phone:</span>
                                <span class="info-value">
                                    <a href="tel:<%= delivery.driverId.userId.phone %>">
                                        <i class="fas fa-phone"></i> <%= delivery.driverId.userId.phone %>
                                    </a>
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Vehicle:</span>
                                <span class="info-value"><%= delivery.vehicleNumber %></span>
                            </div>
                        <% } else { %>
                            <p class="text-muted text-center py-3">No driver assigned</p>
                        <% } %>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="tracking-info-card">
                        <h5 class="mb-3"><i class="fas fa-location-arrow"></i> Live Status</h5>
                        <div class="info-row">
                            <span class="info-label">Current Speed:</span>
                            <span class="info-value" id="current-speed">-- km/h</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Distance Remaining:</span>
                            <span class="info-value" id="distance-remaining">Calculating...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ETA:</span>
                            <span class="info-value" id="eta">Calculating...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Last Update:</span>
                            <span class="info-value" id="last-update">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Map Container -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-map"></i> Live Location Map
                        <span class="float-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleTrafficLayer()">
                                <i class="fas fa-traffic-light"></i> Traffic
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="fitBounds()">
                                <i class="fas fa-expand-arrows-alt"></i> Fit All
                            </button>
                        </span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="map"></div>
                </div>
            </div>
            
            <!-- Location History Timeline -->
            <div class="card mt-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Recent Location Updates</h5>
                </div>
                <div class="card-body">
                    <div id="location-history" class="timeline">
                        <p class="text-muted text-center">Loading location history...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Socket.IO Client -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<!-- Google Maps API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= googleMapsApiKey %>&callback=initMap"></script>

<script>
let map;
let driverMarker;
let pickupMarker;
let deliveryMarker;
let routePath;
let trafficLayer;
let socket;
const deliveryId = '<%= delivery._id %>';

// Initialize Socket.IO
socket = io('<%= process.env.BACKEND_URL || "http://localhost:5000" %>', {
    transports: ['websocket', 'polling']
});

socket.on('connect', () => {
    console.log('Connected to server');
    socket.emit('join-delivery', deliveryId);
});

socket.on('location-update', (data) => {
    console.log('Location update received:', data);
    updateDriverLocation(data);
    updateLiveStatus(data);
    addLocationToHistory(data);
});

// Initialize Google Map
function initMap() {
    const pickupLocation = {
        lat: <%= delivery.pickupLocation.coordinates.latitude %>,
        lng: <%= delivery.pickupLocation.coordinates.longitude %>
    };
    
    const deliveryLocation = {
        lat: <%= delivery.deliveryLocation.coordinates.latitude %>,
        lng: <%= delivery.deliveryLocation.coordinates.longitude %>
    };
    
    <% if (currentLocation) { %>
    const currentDriverLocation = {
        lat: <%= currentLocation.location.coordinates.latitude %>,
        lng: <%= currentLocation.location.coordinates.longitude %>
    };
    <% } %>

    // Create map
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: <% if (currentLocation) { %>currentDriverLocation<% } else { %>pickupLocation<% } %>,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true,
        zoomControl: true,
        styles: [
            {
                featureType: 'poi',
                elementType: 'labels',
                stylers: [{ visibility: 'on' }]
            }
        ]
    });

    // Create traffic layer
    trafficLayer = new google.maps.TrafficLayer();

    // Pickup marker (Green)
    pickupMarker = new google.maps.Marker({
        position: pickupLocation,
        map: map,
        title: 'Pickup Location',
        icon: {
            url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
        }
    });

    const pickupInfoWindow = new google.maps.InfoWindow({
        content: `
            <div style="padding: 10px;">
                <h6><i class="fas fa-map-marker-alt"></i> Pickup Location</h6>
                <p class="mb-0"><%= delivery.pickupLocation.address %></p>
            </div>
        `
    });

    pickupMarker.addListener('click', () => {
        pickupInfoWindow.open(map, pickupMarker);
    });

    // Delivery marker (Red)
    deliveryMarker = new google.maps.Marker({
        position: deliveryLocation,
        map: map,
        title: 'Delivery Location',
        icon: {
            url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
        }
    });

    const deliveryInfoWindow = new google.maps.InfoWindow({
        content: `
            <div style="padding: 10px;">
                <h6><i class="fas fa-map-pin"></i> Delivery Location</h6>
                <p class="mb-1"><strong><%= delivery.deliveryLocation.contactPerson %></strong></p>
                <p class="mb-0"><%= delivery.deliveryLocation.address %></p>
            </div>
        `
    });

    deliveryMarker.addListener('click', () => {
        deliveryInfoWindow.open(map, deliveryMarker);
    });

    // Driver marker (Blue - Moving)
    <% if (currentLocation) { %>
    driverMarker = new google.maps.Marker({
        position: currentDriverLocation,
        map: map,
        title: 'Driver Current Location',
        icon: {
            url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
            scaledSize: new google.maps.Size(50, 50)
        },
        animation: google.maps.Animation.DROP
    });

    const driverInfoWindow = new google.maps.InfoWindow({
        content: `
            <div style="padding: 10px;">
                <h6><i class="fas fa-truck"></i> Driver Location</h6>
                <p class="mb-1"><strong><%= delivery.driverId.userId.name %></strong></p>
                <p class="mb-0">Vehicle: <%= delivery.vehicleNumber %></p>
                <p class="mb-0">Speed: <span id="info-speed"><%= currentLocation.speed || 0 %></span> km/h</p>
            </div>
        `
    });

    driverMarker.addListener('click', () => {
        driverInfoWindow.open(map, driverMarker);
    });
    <% } %>

    // Draw route path
    routePath = new google.maps.Polyline({
        path: [],
        geodesic: true,
        strokeColor: '#4285F4',
        strokeOpacity: 0.8,
        strokeWeight: 4,
        map: map
    });

    // Load route history
    loadRouteHistory();

    // Fit map to show all markers
    fitBounds();
}

// Update driver location on map
function updateDriverLocation(data) {
    const newPosition = {
        lat: data.location.latitude,
        lng: data.location.longitude
    };

    if (!driverMarker) {
        // Create driver marker if doesn't exist
        driverMarker = new google.maps.Marker({
            position: newPosition,
            map: map,
            title: 'Driver Current Location',
            icon: {
                url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                scaledSize: new google.maps.Size(50, 50)
            }
        });
    } else {
        // Animate marker movement
        animateMarker(driverMarker, newPosition);
    }

    // Add point to route path
    const path = routePath.getPath();
    path.push(newPosition);

    // Pan map to new location (optional)
    // map.panTo(newPosition);
}

// Animate marker movement
function animateMarker(marker, newPosition) {
    const startPosition = marker.getPosition();
    let progress = 0;
    const duration = 1000; // 1 second animation
    const steps = 60;
    const stepDuration = duration / steps;

    const animate = setInterval(() => {
        progress += 1 / steps;
        if (progress >= 1) {
            clearInterval(animate);
            marker.setPosition(newPosition);
            return;
        }

        const lat = startPosition.lat() + (newPosition.lat - startPosition.lat()) * progress;
        const lng = startPosition.lng() + (newPosition.lng - startPosition.lng()) * progress;
        
        marker.setPosition(new google.maps.LatLng(lat, lng));
    }, stepDuration);
}

// Update live status panel
function updateLiveStatus(data) {
    document.getElementById('current-speed').textContent = (data.speed || 0) + ' km/h';
    document.getElementById('distance-remaining').textContent = data.distanceFromDestination + ' km';
    
    if (data.estimatedArrival) {
        const eta = new Date(data.estimatedArrival);
        document.getElementById('eta').textContent = eta.toLocaleTimeString();
    }
    
    const lastUpdate = new Date(data.timestamp);
    document.getElementById('last-update').textContent = lastUpdate.toLocaleTimeString();
}

// Load route history from API
async function loadRouteHistory() {
    try {
        const response = await fetch(`/api/tracking/route/<%= delivery._id %>`);
        const result = await response.json();
        
        if (result.success && result.data.route) {
            const path = result.data.route.map(point => ({
                lat: point.latitude,
                lng: point.longitude
            }));
            
            routePath.setPath(path);
        }
    } catch (error) {
        console.error('Error loading route history:', error);
    }
}

// Add location to history timeline
function addLocationToHistory(data) {
    const historyContainer = document.getElementById('location-history');
    const timestamp = new Date(data.timestamp).toLocaleTimeString();
    
    const historyItem = `
        <div class="timeline-item mb-3">
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-map-marker-alt text-primary"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <div class="d-flex justify-content-between">
                        <strong>${timestamp}</strong>
                        <span class="badge bg-primary">${data.speed || 0} km/h</span>
                    </div>
                    <p class="mb-0 text-muted">${data.location.address || 'Location updated'}</p>
                    <small class="text-muted">Distance remaining: ${data.distanceFromDestination}</small>
                </div>
            </div>
        </div>
    `;
    
    historyContainer.insertAdjacentHTML('afterbegin', historyItem);
    
    // Keep only last 10 items
    const items = historyContainer.querySelectorAll('.timeline-item');
    if (items.length > 10) {
        items[items.length - 1].remove();
    }
}

// Center map on driver
function centerMap() {
    if (driverMarker) {
        map.setCenter(driverMarker.getPosition());
        map.setZoom(15);
    }
}

// Toggle traffic layer
function toggleTrafficLayer() {
    if (trafficLayer.getMap()) {
        trafficLayer.setMap(null);
    } else {
        trafficLayer.setMap(map);
    }
}

// Fit map to show all markers
function fitBounds() {
    const bounds = new google.maps.LatLngBounds();
    
    if (pickupMarker) bounds.extend(pickupMarker.getPosition());
    if (deliveryMarker) bounds.extend(deliveryMarker.getPosition());
    if (driverMarker) bounds.extend(driverMarker.getPosition());
    
    map.fitBounds(bounds);
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    socket.emit('leave-delivery', deliveryId);
    socket.disconnect();
});

// Auto-refresh current location every 30 seconds (fallback)
setInterval(async () => {
    try {
        const response = await fetch(`/api/tracking/current/<%= delivery._id %>`);
        const result = await response.json();
        
        if (result.success && result.data.currentLocation) {
            updateDriverLocation(result.data.currentLocation);
            updateLiveStatus(result.data);
        }
    } catch (error) {
        console.error('Error fetching current location:', error);
    }
}, 30000);
</script>

<%- include('../layouts/footer') %>