<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">

<head>
    <%- include('_layouts/head') %>
        <title>Customers Management | <%= title %></title>

        <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/jquery.dataTables.min.css">
        <link rel="stylesheet" type="text/css"
            href="/app-assets/vendors/data-tables/extensions/responsive/css/responsive.dataTables.min.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/select.dataTables.min.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/css/pages/data-tables.css">

        <style>
            table tr td,
            th {
                text-align: center;
            }

            [type='checkbox']+span:not(.lever):before {
                border-color: black;
            }

            [type='checkbox']:checked+span:not(.lever):before {
                border-right-color: black;
                border-bottom-color: black;
            }

            /* Name cell with ellipsis for long names */
            .name-cell {
                max-width: 240px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .company-name {
                font-weight: bold;
                display: block;
            }

            .individual-name {
                font-size: 0.9em;
                color: #555;
            }

            /* âœ… Fix: Hide DataTables' auto-generated image sorting icons */
            table.dataTable thead th {
                background-image: none !important;
            }

            table.dataTable thead .sorting:before,
            table.dataTable thead .sorting:after,
            table.dataTable thead .sorting_asc:before,
            table.dataTable thead .sorting_asc:after,
            table.dataTable thead .sorting_desc:before,
            table.dataTable thead .sorting_desc:after {
                display: none !important;
            }
        </style>
</head>

<body
    class="vertical-layout page-header-light vertical-menu-collapsible vertical-dark-menu preload-transitions 2-columns"
    data-open="click" data-menu="vertical-dark-menu" data-col="2-columns">

    <%- include('_layouts/sidenavbar') %>

        <div id="main">
            <div class="row">
                <div class="pt-1 pb-0" id="breadcrumbs-wrapper">
                    <div class="container">
                        <div class="row">
                            <%- include('messages', { messages: messages }) %>
                                <div class="col s12 m6 l6">
                                    <h6 class="breadcrumbs-title"><span>Manage Customers</span></h6>
                                </div>
                                <div class="col s12 m6 l6 right-align-md"
                                    style="display: flex; justify-content: flex-end; gap: 10px;">
                                    <a class="btn pull-right btn-add btn-breadcrumbs white-text"
                                        href="/admin/customers/create-customer">Create Customer</a>
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col s12">
                <div class="container">
                    <div class="section section-data-tables">
                        <div class="row">
                            <div class="col s12">
                                <div class="card">
                                    <div class="card-content">
                                        <div class="row">
                                            <div class="col s12 overflow">
                                                <table id="page-length-option" class="display">
                                                    <thead>
                                                        <tr>
                                                            <th>Sr</th>
                                                            <th style="width: 60px; text-align: center;">
                                                                <label style="margin: 0; display: flex; align-items: center; justify-content: center;">
                                                                    <input type="checkbox" id="selectAll" />
                                                                    <span>Select</span>
                                                                </label>
                                                            </th>
                                                            <th>Name</th>
                                                            <th>Phone</th>
                                                            <th>Email</th>
                                                            <th>Type</th>
                                                            <th>Category</th>
                                                            <th>Status</th>
                                                            <th>Created Date</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% if (customers && customers.length > 0) { %>
                                                            <% customers.forEach((customer, index) => { %>
                                                                <% 
                                                                    const primaryLocation = customer.getPrimaryLocation ? 
                                                                        customer.getPrimaryLocation() :
                                                                        customer.locations.find(loc => loc.isPrimary) || 
                                                                        customer.locations[0] || 
                                                                        {};
                                                                    const primaryAddress = primaryLocation
                                                                        ? `${primaryLocation.city || ''}, ${primaryLocation.state || ''}`.trim()
                                                                        : 'N/A';
                                                                %>
                                                                <tr>
                                                                    <td><%= index + 1 + ((pagination?.page - 1) * (pagination?.limit || 20) || 0) %></td>
                                                                    <td>
                                                                        <label>
                                                                            <input type="checkbox" name="selectedCustomers[]" value="<%= customer._id %>" />
                                                                            <span></span>
                                                                        </label>
                                                                    </td>
                                                                    <td class="name-cell" title="<%= customer.companyName || customer.name %>">
                                                                        <% if (customer.companyName) { %>
                                                                            <span class="company-name"><%= customer.companyName %></span>
                                                                        <% } else { %>
                                                                            <span class="individual-name"><%= customer.name %></span>
                                                                        <% } %>
                                                                    </td>
                                                                    <td>
                                                                        <%= customer.phone || customer.alternatePhone || 'N/A' %>
                                                                    </td>
                                                                    <td><%= customer.email || 'N/A' %></td>
                                                                    <td>
                                                                        <span class="badge" style="background-color: <%= 
                                                                            customer.customerType === 'enterprise' ? 'purple' :
                                                                            customer.customerType === 'business' ? 'rgb(214,221, 235)' :
                                                                            'rgb(212, 240, 216)'%>;
                                                                            color: <%= 
                                                                            customer.customerType === 'enterprise' ? 'white' :
                                                                            customer.customerType === 'business' ? 'blue' :
                                                                            'green'%>;">
                                                                            <%= customer.customerType?.toUpperCase() || 'INDIVIDUAL' %>
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        <span class="badge" style="background-color: <%= customer.category === 'vip' ? 'rgb(243, 248, 174)' : 'rgb(180, 228, 228)' %>;
                                                                            color: <%= customer.category === 'vip' ? 'orange' : 'teal' %>;">
                                                                            <%= customer.category?.toUpperCase() || 'REGULAR' %>
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        <span class="badge <%= customer.status === 'active' ? 'green' : 
                                                                            customer.status === 'inactive' ? 'red' : 'orange' %>">
                                                                            <%= customer.status?.toUpperCase() || 'UNKNOWN' %>
                                                                        </span>
                                                                    </td>
                                                                   
                                                                    <td>
                                                                        <% 
                                                                            let formattedDate = '-';
                                                                            if (customer.createdAt) {
                                                                                const d = new Date(customer.createdAt);
                                                                                const day = String(d.getUTCDate()).padStart(2, '0');
                                                                                const month = String(d.getUTCMonth() + 1).padStart(2, '0');
                                                                                const year = d.getUTCFullYear();
                                                                                const hours = String(d.getUTCHours()).padStart(2, '0');
                                                                                const minutes = String(d.getUTCMinutes()).padStart(2, '0');
                                                                                formattedDate = `${day}-${month}-${year} ${hours}:${minutes}`;
                                                                            }
                                                                        %>
                                                                        <%= formattedDate %>
                                                                    </td>
                                                                    <td>
                                                                        <a href="/admin/customers/view/<%= customer._id %>"
                                                                            class="waves-effect waves-light accent-2 btn-edit"
                                                                            title="View Details">
                                                                            <i class="material-icons">visibility</i>
                                                                        </a>
                                                                        &nbsp;&nbsp;
                                                                        <a href="/admin/customers/<%= customer._id %>/edit"
                                                                            class="btn-floating waves-effect waves-light accent-2 btn-edit"
                                                                            title="Edit">
                                                                            <i class="material-icons">edit</i>
                                                                        </a>
                                                                        &nbsp;&nbsp;
                                                                        <a href="#"
                                                                            class="btn-floating waves-effect waves-light red"
                                                                            onclick="confirmCustomerDelete('<%= customer._id %>', '<%= (customer.companyName || customer.name || customer.customerId) %>')"
                                                                            title="Delete Customer">
                                                                            <i class="material-icons">delete</i>
                                                                        </a>
                                                                    </td>
                                                                </tr>
                                                            <% }) %>
                                                        <% } else { %>
                                                            <tr>
                                                                <td colspan="11" class="center-align grey-text">
                                                                    No customers found matching your criteria
                                                                </td>
                                                            </tr>
                                                        <% } %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pagination -->
                        <% if (pagination && pagination.pages > 1) { %>
                            <div class="right-align mt-2">
                                Page <%= pagination.page %> of <%= pagination.pages %> (Total: <%= pagination.total %>)
                                <% if (pagination.page > 1) { %>
                                    <a href="?page=<%= pagination.page - 1 %>&<%= new URLSearchParams(Object.assign({}, req.query, {page: pagination.page - 1})).toString() %>"
                                        class="btn-flat">Prev</a>
                                <% } %>
                                <% if (pagination.page < pagination.pages) { %>
                                    <a href="?page=<%= pagination.page + 1 %>&<%= new URLSearchParams(Object.assign({}, req.query, {page: pagination.page + 1})).toString() %>"
                                        class="btn-flat">Next</a>
                                <% } %>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <%- include('_layouts/commonJs') %>

                <script src="/app-assets/vendors/data-tables/js/jquery.dataTables.min.js"></script>
                <script src="/app-assets/js/scripts/data-tables.js"></script>

                <script>
                    // Select All Checkbox
                    document.addEventListener('DOMContentLoaded', function () {
                        const selectAll = document.getElementById('selectAll');
                        const checkboxes = document.querySelectorAll('input[name="selectedCustomers[]"]');

                        if (selectAll) {
                            selectAll.addEventListener('change', function () {
                                checkboxes.forEach(cb => cb.checked = this.checked);
                            });
                        }

                        M.FormSelect.init(document.querySelectorAll('select'));
                    });

                    function confirmCustomerDelete(customerId, customerName) {
                        if (confirm(`Are you sure you want to PERMANENTLY delete customer "${customerName}"?\n\nThis action cannot be undone and will remove all data and uploaded documents.`)) {
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = `/admin/customers/${customerId}/delete`;
                            document.body.appendChild(form);
                            form.submit();
                        }
                    }
                </script>
</body>

</html>