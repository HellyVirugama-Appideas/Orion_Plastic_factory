<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">

<head>
    <%- include('_layouts/head') %>
        <title>Expense Details | <%= title %>
        </title>

        <link rel="stylesheet" type="text/css" href="/app-assets/css/pages/page-users.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/jquery.dataTables.min.css">
        <link rel="stylesheet" type="text/css"
            href="/app-assets/vendors/data-tables/extensions/responsive/css/responsive.dataTables.min.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/vendors/data-tables/css/select.dataTables.min.css">
        <link rel="stylesheet" type="text/css" href="/app-assets/css/pages/data-tables.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <style>
            table tr td,
            th {
                text-align: center;
            }

            [type='checkbox']+span:not(.lever):before {
                border-color: black;
            }

            [type='checkbox']:checked+span:not(.lever):before {
                border-right-color: black;
                border-bottom-color: black;
            }

            .badge {
                padding: 5px 10px;
                border-radius: 12px;
                font-size: 12px;
            }

            .status-badge {
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 0.85rem;
                display: inline-block;
            }

            .pending {
                background: #fff3cd;
                color: #856404;
            }

            .approved_by_admin {
                background: #d4edda;
                color: #155724;
            }

            .approved_by_finance {
                background: #cce5ff;
                color: #004085;
            }

            .rejected {
                background: #f8d7da;
                color: #721c24;
            }

            /* Responsive fixes */
            @media (max-width: 768px) {
                .action-section {
                    flex-direction: column !important;
                    align-items: flex-start !important;
                    gap: 15px !important;
                }
            }

            /* receipts section */
            /* Receipts Gallery Improvements */
            .receipts-gallery .receipt-thumbnail {
                position: relative;
                overflow: hidden;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
                transition: all 0.3s ease;
            }

            .receipts-gallery .receipt-thumbnail:hover {
                transform: scale(1.03);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            }

            .receipt-modal img {
                max-width: 95vw;
                max-height: 85vh;
                object-fit: contain;
            }

            .receipt-modal .modal-content {
                background: #000;
                border-radius: 8px;
                overflow: hidden;
            }

            /* Small screens adjustment */
            @media (max-width: 600px) {
                .receipts-gallery .col {
                    width: 50% !important;
                }

                .receipt-thumbnail img {
                    height: 140px !important;
                }
            }
        </style>
</head>

<body
    class="vertical-layout page-header-light vertical-menu-collapsible vertical-dark-menu preload-transitions 2-columns"
    data-open="click" data-menu="vertical-dark-menu" data-col="2-columns">

    <%- include('_layouts/sidenavbar') %>

        <div id="main">
            <div class="row">
                <!-- Breadcrumbs -->
                <div id="breadcrumbs-wrapper" style="background-color: white;">
                    <div class="container">
                        <div class="row">
                            <div class="col s12 m6 l6">
                                <h5 class="breadcrumbs-title"><span>Expense Details</span></h5>
                            </div>
                            <div class="col s12 m6 l6 right-align-md">
                                <a href="/admin/expenses"
                                    class="btn gradient-45deg-purple-deep-orange pull-right btn-breadcrumbs">
                                    Back to Expenses
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <%- include('messages', { messages: messages }) %>

                    <div class="col s12">
                        <div class="container">
                            <div class="section users-view">

                                <!-- HEADER CARD -->
                                <div class="card-panel">
                                    <div class="row">
                                        <div class="col s12 m7">
                                            <div class="display-flex media">
                                                <div class="media-body" style="margin-left: 10px;">
                                                    <h5>Expense #<%= expense._id.toString().slice(-8) %>
                                                    </h5>
                                                    <span>Date:</span>
                                                    <span class="users-view-id">
                                                        <%= new Date(expense.expenseDate).toLocaleString('en-IN') %>
                                                    </span><br>
                                                    <span>Driver:</span>
                                                    <span class="users-view-id">
                                                        <%= expense.driver?.name || 'N/A' %> (<%= expense.driver?.phone
                                                                || 'N/A' %>)
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- RIGHT SIDE: STATUS + ACTIONS -->
                                        <div class="col s12 m5" style="text-align: right;">
                                            <div class="action-section"
                                                style="display: flex; align-items: center; justify-content: flex-end; gap: 20px; flex-wrap: wrap;">

                                                <!-- Current Status Badge -->
                                                <span class="status-badge <%= expense.approvalStatus %>">
                                                    <%= expense.approvalStatus.replace(/_/g, ' ' ).toUpperCase() %>
                                                </span>

                                                <!-- Action Buttons -->
                                                <div
                                                    style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                                                    <% if (expense.approvalStatus==='pending' ) { %>
                                                        <a href="#approveModal"
                                                            class="btn-small green modal-trigger waves-effect waves-light">
                                                            Approve
                                                        </a>
                                                        <a href="#rejectModal"
                                                            class="btn-small red modal-trigger waves-effect waves-light">
                                                            Reject
                                                        </a>
                                                        <% } else { %>
                                                            <span class="btn-small grey disabled">Action
                                                                Completed</span>
                                                            <% } %>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Expense Basic Information -->
                                <div class="card">
                                    <div class="card-content">
                                        <h5>Expense Information</h5>
                                        <div class="row">
                                            <div class="col s12 m6">
                                                <table class="striped">
                                                    <tbody>
                                                        <tr>
                                                            <th style="width: 200px;">Driver Name</th>
                                                            <td>
                                                                <%= expense.driver?.name || '-' %>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Phone</th>
                                                            <td>
                                                                <%= expense.driver?.phone || '-' %>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Vehicle Number</th>
                                                            <td>
                                                                <%= expense.vehicle?.vehicleNumber || 'Not Assigned' %>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Expense Type</th>
                                                            <td>
                                                                <span
                                                                    class="badge <%= expense.expenseType === 'fuel' ? 'blue' : 'purple' %>">
                                                                    <%= expense.expenseType.toUpperCase() %>
                                                                </span>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Total Amount</th>
                                                            <td>
                                                                ₹ <%= (expense.expenseType==='fuel' ?
                                                                    (expense.fuelDetails?.totalFuelCost || 0) :
                                                                    (expense.vehicleExpenseDetails?.expenseAmount || 0)
                                                                    ).toLocaleString('en-IN') %>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Status</th>
                                                            <td>
                                                                <span
                                                                    class="status-badge <%= expense.approvalStatus %>">
                                                                    <%= expense.approvalStatus.replace(/_/g, ' '
                                                                        ).toUpperCase() %>
                                                                </span>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Payment Status</th>
                                                            <td>
                                                                <%= expense.paymentStatus.toUpperCase() %>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <!-- Right Side Details -->
                                            <div class="col s12 m6">
                                                <% if (expense.expenseType==='fuel' && expense.fuelDetails) { %>
                                                    <h6>Fuel Details</h6>
                                                    <table class="striped">
                                                        <tbody>
                                                            <tr>
                                                                <th>Quantity</th>
                                                                <td>
                                                                    <%= expense.fuelDetails.quantity || 0 %> Ltr
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <th>Price/Ltr</th>
                                                                <td>₹ <%= expense.fuelDetails.pricePerLitre || 0 %>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <th>Total Cost</th>
                                                                <td>₹ <%= expense.fuelDetails.totalFuelCost || 0 %>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <th>Fuel Type</th>
                                                                <td>
                                                                    <%= expense.fuelDetails.fuelType || 'N/A' %>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                    <% } %>

                                                        <% if (expense.mileageData?.averageMileage) { %>
                                                            <h6 class="mt-3">Mileage Information</h6>
                                                            <table class="striped">
                                                                <tbody>
                                                                    <tr>
                                                                        <th>Distance Covered</th>
                                                                        <td>
                                                                            <%= expense.mileageData.distanceCovered || 0
                                                                                %> km
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <th>Average Mileage</th>
                                                                        <td>
                                                                            <%= expense.mileageData.averageMileage %>
                                                                                km/l
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                            <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Receipts Section -->
                                <!-- Receipts Section -->
                                <% if (expense.receipts?.length> 0) { %>
                                    <div class="card">
                                        <div class="card-content">
                                            <h5>Receipts & Documents</h5>
                                            <div class="row mt-2 receipts-gallery">
                                                <% expense.receipts.forEach((receipt, index)=> { %>
                                                    <div class="col s6 m4 l3 mb-3">
                                                        <div class="receipt-thumbnail">
                                                            <a href="<%= receipt.url %>"
                                                                class="receipt-link modal-trigger"
                                                                data-target="receiptModal-<%= index %>">
                                                                <img src="<%= receipt.url %>"
                                                                    class="responsive-img z-depth-1 hoverable"
                                                                    alt="Receipt <%= index + 1 %>"
                                                                    style="height: 180px; object-fit: cover; width: 100%;">
                                                            </a>
                                                            <p class="text-center mt-1 small grey-text text-darken-1">
                                                                <%= receipt.type.replace(/_/g, ' ' ) %>
                                                            </p>
                                                        </div>

                                                        <!-- Modal for this receipt -->
                                                        <div id="receiptModal-<%= index %>" class="modal receipt-modal">
                                                            <div class="modal-content"
                                                                style="padding: 0; background: #000;">
                                                                <a href="#!" class="modal-close btn-flat"
                                                                    style="position: absolute; top: 15px; right: 15px; z-index: 1000; color: white; background: rgba(0,0,0,0.6); border-radius: 50%; padding: 5px 10px;">
                                                                    <i class="material-icons">close</i>
                                                                </a>
                                                                <img src="<%= receipt.url %>" class="responsive-img"
                                                                    alt="Receipt <%= index + 1 %>"
                                                                    style="max-height: 90vh; width: auto; margin: 0 auto; display: block;">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% }) %>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>

                            </div>
                        </div>
                    </div>
            </div>

            <%- include('_layouts/commonJs') %>

                <!-- Modal for Approve -->
                <div id="approveModal" class="modal">
                    <div class="modal-content">
                        <h4>Approve Expense</h4>
                        <p>Are you sure you want to approve this expense and forward it to finance?</p>
                        <form action="/admin/expenses/<%= expense._id %>/approve" method="POST">
                            <div class="input-field">
                                <textarea id="comments" name="comments" class="materialize-textarea"></textarea>
                                <label for="comments">Admin Comments (optional)</label>
                            </div>
                            <button type="submit" class="btn green waves-effect waves-light">Approve</button>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancel</a>
                    </div>
                </div>

                <!-- Modal for Reject -->
                <div id="rejectModal" class="modal">
                    <div class="modal-content">
                        <h4>Reject Expense</h4>
                        <p>Please provide reason for rejection.</p>
                        <form action="/admin/expenses/<%= expense._id %>/reject" method="POST">
                            <div class="input-field">
                                <textarea id="reason" name="reason" class="materialize-textarea" required></textarea>
                                <label for="reason">Rejection Reason <span class="red-text">*</span></label>
                            </div>
                            <button type="submit" class="btn red waves-effect waves-light">Reject</button>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancel</a>
                    </div>
                </div>

                <script>
                    $(document).ready(function () {
                        $('.modal').modal();
                    });
                </script>
</body>

</html>